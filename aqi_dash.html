<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --aqi-good: #4caf50;
            --aqi-satisfactory: #8bc34a;
            --aqi-moderate: #ffc107;
            --aqi-poor: #ff9800;
            --aqi-very-poor: #f44336;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0px 5px;
            background: transparent;
            display: flex;
            justify-content: center;
        }

        .bulletin-card {
            width: 100%;
            max-width: 700px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.06);
            padding: 20px;
            text-align: center;
        }

        /* --- Header Styling --- */
        .title-area { 
            color: #002b45; 
            font-size: 18px; 
            font-weight: 600; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
        }

        .location-link {
            color: inherit;
            text-decoration: underline; /* Underline as requested */
        }

        /* --- Hero Area Layout --- */
        .status-hero { 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            margin-bottom: 15px;
        }

        .status-main-row {
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        /* Wood Stove Alert */
        #woodStoveAlert {
            font-size: 10px;
            font-weight: 800;
            color: #d32f2f;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 14px; 
            margin-bottom: 8px;
            animation: blinker 1.5s linear infinite;
            display: none; 
        }

        @keyframes blinker { 50% { opacity: 0; } }

        /* Animated Pulsing Ring */
        .status-dot-container {
            position: relative;
            width: 50px;
            height: 50px;
        }

        .status-dot { 
            position: absolute;
            top: 5px; left: 5px;
            width: 40px; height: 40px; 
            border-radius: 50%; 
            background: #ddd; 
            z-index: 2;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .pulse-ring {
            position: absolute;
            top: 0; left: 0;
            width: 50px;
            height: 50px;
            background: #ddd;
            border-radius: 50%;
            opacity: 0.6;
            animation: pulse 2s infinite;
            z-index: 1;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.8; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        .status-text { font-size: 24px; font-weight: 800; color: #1a1a1a; }

        /* --- Legend & Footer --- */
        .legend-bar { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 15px; }
        .legend-item { padding: 6px 10px; border-radius: 6px; color: white; font-size: 11px; font-weight: 600; min-width: 90px; }
        .l-good { background: var(--aqi-good); }
        .l-satisfactory { background: var(--aqi-satisfactory); }
        .l-moderate { background: var(--aqi-moderate); }
        .l-poor { background: var(--aqi-poor); }
        .l-very-poor { background: var(--aqi-very-poor); }

        .health-advice { font-size: 14px; color: #333; margin-bottom: 8px; line-height: 1.4; padding: 0 10px; }
        .malayalam-text { font-size: 18px; color: #002b45; font-weight: bold; margin-bottom: 8px; }
        .more-info-link { font-size: 11px; color: #0056b3; text-decoration: none; display: block; margin-bottom: 15px; }

        .sensor-footer { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr);
            border-top: 1px solid #eee; 
            padding-top: 15px;
            margin-top: 10px;
        }
        .sensor-item { text-align: center; }
        .sensor-label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 2px; }
        .sensor-val { font-size: 14px; font-weight: 600; color: #444; }

        .indicator-bar {
            display: block;
            height: 4px;
            width: 60px;
            margin: 6px auto 0 auto;
            border-radius: 4px;
            transition: 0.3s ease;
        }

        .attribution { font-size: 10px; color: #aaa; margin-top: 15px; border-top: 1px dotted #eee; padding-top: 10px; }
        .attribution a { color: #888; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="bulletin-card">
    <div class="title-area">
        <img src="https://www.gstatic.com/images/icons/material/system_gm/1x/cloud_white_24dp.png" style="filter: invert(1); width:20px;" alt="">
        <a href="https://maps.app.goo.gl/cNz5SeVwk4t3PMvQ8" target="_blank" class="location-link">Elamkulam</a> Air Quality Index (AQI) | Residential Area
    </div>

    <div class="status-hero">
        <div id="woodStoveAlert">‚ö†Ô∏è Residential Wood Stove Burning: AQI Increased</div>
        
        <div class="status-main-row">
            <div class="status-dot-container">
                <div id="pulseRing" class="pulse-ring"></div>
                <div id="statusDot" class="status-dot"></div>
            </div>
            <div id="statusText" class="status-text">AQI --</div>
        </div>
    </div>

    <div class="legend-bar">
        <div class="legend-item l-good">0‚Äì50 Good</div>
        <div class="legend-item l-satisfactory">51‚Äì100 Satisfactory</div>
        <div class="legend-item l-moderate">101‚Äì200 Moderate</div>
        <div class="legend-item l-poor">201‚Äì300 Poor</div>
        <div class="legend-item l-very-poor">301‚Äì500 Very Poor</div>
    </div>

    <div id="healthAdvice" class="health-advice">Loading air quality data...</div>
    <div class="malayalam-text">‡¥á‡¥®‡µç‡¥®‡¥§‡µç‡¥§‡µÜ ‡¥∂‡µÅ‡¥¶‡µç‡¥ß‡¥µ‡¥æ‡¥Ø‡µÅ, ‡¥®‡¥æ‡¥≥‡µÜ‡¥Ø‡µÅ‡¥ü‡µÜ ‡¥Ü‡¥∞‡µã‡¥ó‡µç‡¥Ø‡¥Ç.</div>
    <a href="AQI-advise.html" target="_blank" class="more-info-link">
        AQI ‡¥é‡¥®‡µç‡¥§‡µÜ‡¥®‡µç‡¥®‡µÅ‡¥Ç, ‡¥é‡¥ô‡µç‡¥ô‡¥®‡µÜ‡¥Ø‡µÜ‡¥®‡µç‡¥®‡µÅ‡¥Ç ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡µΩ ‡¥Ö‡¥±‡¥ø‡¥Ø‡¥æ‡¥Ç.
    </a>

    <div class="sensor-footer">
        <div class="sensor-item">
            <div class="sensor-label">PM10 (¬µg/m¬≥)</div>
            <div class="sensor-val"><span id="pm10">--</span></div>
            <span id="pm10-ind" class="indicator-bar" style="background:#ccc"></span>
        </div>
        <div class="sensor-item">
            <div class="sensor-label">CO‚ÇÇ (ppm)</div>
            <div class="sensor-val"><span id="co2">--</span></div>
            <span id="co2-ind" class="indicator-bar" style="background:#ccc"></span>
        </div>
        <div class="sensor-item">
            <div class="sensor-label">TVOC Index</div>
            <div class="sensor-val"><span id="tvoc">--</span></div>
            <span id="tvoc-ind" class="indicator-bar" style="background:#ccc"></span>
        </div>
        <div class="sensor-item">
            <div class="sensor-label">NOx Index</div>
            <div class="sensor-val"><span id="nox">--</span></div>
            <span id="nox-ind" class="indicator-bar" style="background:#ccc"></span>
        </div>
    </div>

    <div class="attribution">
Data Source: ELWOIC Station API |
Real-time monitoring powered by sponsored hardware from AirGradient |
Last Updated: <span id="time">--</span> |
Licensed under 
<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">
CC BY-SA 4.0
</a> |
<a href="https://www.airgradient.com" target="_blank">AirGradient</a>
</div>
</div>

<script>
const API_URL = "https://curly-sound-5bea.elwoicelamkulam.workers.dev/api";

function pm25ToAQI(pm) {
    const bp = [
        { cL: 0, cH: 12, aL: 0, aH: 50 },
        { cL: 12.1, cH: 35.4, aL: 51, aH: 100 },
        { cL: 35.5, cH: 55.4, aL: 101, aH: 150 },
        { cL: 55.5, cH: 150.4, aL: 151, aH: 200 },
        { cL: 150.5, cH: 250.4, aL: 201, aH: 300 },
        { cL: 250.5, cH: 500, aL: 301, aH: 500 }
    ];
    for (const r of bp) {
        if (pm >= r.cL && pm <= r.cH) return Math.round(((r.aH - r.aL)/(r.cH - r.cL))*(pm - r.cL) + r.aL);
    }
    return Math.round(pm);
}

function getStatus(aqi) {
    if (aqi <= 50) return { text: "Good", color: "#4caf50", emoji: "üòÄ", advice_en: "Air quality is good.", advice_ml: "‡¥µ‡¥æ‡¥Ø‡µÅ ‡¥ó‡µÅ‡¥£‡¥®‡¥ø‡¥≤‡¥µ‡¥æ‡¥∞‡¥Ç ‡¥®‡¥≤‡µç‡¥≤‡¥§‡¥æ‡¥£‡µç." };
    if (aqi <= 100) return { text: "Satisfactory", color: "#8bc34a", emoji: "üôÇ", advice_en: "Air quality is satisfactory.", advice_ml: "‡¥µ‡¥æ‡¥Ø‡µÅ ‡¥ó‡µÅ‡¥£‡¥®‡¥ø‡¥≤‡¥µ‡¥æ‡¥∞‡¥Ç ‡¥§‡µÉ‡¥™‡µç‡¥§‡¥ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥£‡µç." };
    if (aqi <= 200) return { text: "Moderate", color: "#ffc107", emoji: "üòê", advice_en: "Moderate pollution.", advice_ml: "‡¥Æ‡¥ø‡¥§‡¥Æ‡¥æ‡¥Ø ‡¥µ‡¥æ‡¥Ø‡µÅ ‡¥Æ‡¥≤‡¥ø‡¥®‡µÄ‡¥ï‡¥∞‡¥£‡¥Ç." };
    if (aqi <= 300) return { text: "Poor", color: "#ff9800", emoji: "üò∑", advice_en: "Poor air quality.", advice_ml: "‡¥µ‡¥æ‡¥Ø‡µÅ ‡¥ó‡µÅ‡¥£‡¥®‡¥ø‡¥≤‡¥µ‡¥æ‡¥∞‡¥Ç ‡¥Æ‡µã‡¥∂‡¥Æ‡¥æ‡¥£‡µç." };
    return { text: "Very Poor", color: "#f44336", emoji: "‚òπÔ∏è", advice_en: "Health alert.", advice_ml: "‡¥Ü‡¥∞‡µã‡¥ó‡µç‡¥Ø ‡¥Ö‡¥ü‡¥ø‡¥Ø‡¥®‡µç‡¥§‡¥∞‡¥æ‡¥µ‡¥∏‡µç‡¥•." };
}

function getColorByLevel(value, type){
    if(value === null || value === undefined || isNaN(value)) return "#cccccc";
    if(type === "pm10") return value <= 50 ? "#4caf50" : value <= 100 ? "#ffc107" : "#f44336";
    if(type === "co2") return value <= 800 ? "#4caf50" : value <= 1200 ? "#ffc107" : "#f44336";
    if(type === "tvoc" || type === "nox") return value <= 100 ? "#4caf50" : value <= 200 ? "#ffc107" : "#f44336";
    return "#cccccc";
}

async function updateDashboard() {
    try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("Network response not OK");
        let data = await res.json();
        if (Array.isArray(data)) data = data[0];

        const pm = parseFloat(data?.pm02_corrected ?? 0);
        const pm10 = parseFloat(data?.pm10_corrected) || 0;
        const aqi = pm25ToAQI(pm);
        const st = getStatus(aqi);

        document.getElementById("statusDot").style.background = st.color;
        document.getElementById("pulseRing").style.background = st.color;
        document.getElementById("statusText").innerText = `AQI ${aqi} ‚Äî ${st.text} ${st.emoji}`;
        
        const now = new Date();
        const hour = now.getHours();
        const alertDiv = document.getElementById("woodStoveAlert");
        
        if (hour >= 5 && hour < 9 && pm > 45) {
            alertDiv.style.display = "block";
        } else {
            alertDiv.style.display = "none";
        }

        document.getElementById("healthAdvice").innerHTML = `${st.advice_en}<br>${st.advice_ml}<br>(PM2.5: ${pm} ¬µg/m¬≥ | PM10: ${pm10} ¬µg/m¬≥)`;

        document.getElementById("pm10").innerText = pm10;
        document.getElementById("pm10-ind").style.background = getColorByLevel(pm10, "pm10");
        
        const co2 = parseFloat(data?.rco2_corrected) || 0;
        document.getElementById("co2").innerText = co2;
        document.getElementById("co2-ind").style.background = getColorByLevel(co2, "co2");

        const tvoc = parseFloat(data?.tvocIndex) || 0;
        document.getElementById("tvoc").innerText = tvoc;
        document.getElementById("tvoc-ind").style.background = getColorByLevel(tvoc, "tvoc");

        const nox = parseFloat(data?.noxIndex) || 0;
        document.getElementById("nox").innerText = nox;
        document.getElementById("nox-ind").style.background = getColorByLevel(nox, "nox");

        document.getElementById("time").innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    } catch (e) {
        console.error(e);
        document.getElementById("statusText").innerText = "Offline";
    }
}

updateDashboard();
// Set to 180,000ms = 3 Minutes
setInterval(updateDashboard, 180000); 
</script>

</body>
</html>
