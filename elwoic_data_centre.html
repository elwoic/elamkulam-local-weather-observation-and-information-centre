<!DOCTYPE html>
<html lang="en">
<head>
  
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ELWOIC â€” Admin Data Centre</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const authConfig = {
  apiKey: "AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
  authDomain: "administration-protal.firebaseapp.com"
};

const authApp = initializeApp(authConfig, "adminAuthApp");
const auth = getAuth(authApp);

onAuthStateChanged(auth, user => {
  if (!user) { window.location.replace("data_login.html"); }
});

window.logout = () => {
  signOut(auth).then(() => { window.location.replace("data_login.html"); });
};
</script>

<style>
:root{
  --bg:#f1f5f9;--panel:#fff;--border:#cbd5e1;
  --text:#0f172a;--muted:#64748b;
  --accent:#2563eb;--weather:#10b981;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Segoe UI,sans-serif;
  background:var(--bg);color:var(--text)
}
.container{
  max-width:1100px;margin:auto;padding:20px
}
.header{
  display:flex;justify-content:space-between;align-items:center;
  background:#1e293b;color:#fff;padding:20px;border-radius:12px
}
.tab-nav{display:flex;gap:10px;margin:20px 0}
.tab-btn{
  flex:1;padding:14px;border:0;border-radius:8px;
  font-weight:700;cursor:pointer;
  background:var(--border);color:var(--muted)
}
.tab-btn.active{background:var(--accent);color:#fff}
.tab-btn.weather-active{background:var(--weather);color:#fff}

.content-section{display:none}
.content-section.active{display:block}

.search-box{
  width:100%;padding:14px;border-radius:8px;
  border:1px solid var(--border);margin-bottom:15px
}

.date-group{
  border:1px solid var(--border);
  border-radius:10px;margin-bottom:16px;
  background:#fff;overflow:hidden
}
.date-header{
  background:#f8fafc;padding:15px 20px;
  display:flex;justify-content:space-between;
  align-items:center;cursor:pointer
}
.date-content{display:none;padding:15px}
.date-content.open{display:block}

.entry-card{
  border:1px solid #e2e8f0;
  border-radius:8px;padding:14px;
  margin-bottom:10px;background:#fff
}
.entry-head{
  display:flex;justify-content:space-between;
  align-items:center;cursor:pointer
}
.entry-details{
  display:none;margin-top:10px;
  font-size:.9rem;line-height:1.5
}
.entry-details.open{display:block}

.badge{
  padding:4px 10px;border-radius:4px;
  font-size:.75rem;font-weight:700;color:#fff
}
.export-btn{
  background:#0f766e;color:#fff;
  border:0;border-radius:6px;
  padding:6px 12px;font-size:.75rem;
  cursor:pointer
}
.raw{
  font-family:monospace;background:#f1f5f9;
  padding:8px;border-radius:6px;
  font-size:.75rem;white-space:pre-wrap
}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <div>
    <h1 style="margin:0">ELWOIC Admin Centre</h1>
    <small>System Authenticated</small>
  </div>
</div>

<div class="tab-nav">
  <button id="btn-admin" class="tab-btn active">ğŸ› ï¸ Admin Logs</button>
  <button id="btn-weather" class="tab-btn">ğŸŒ¤ï¸ Weather History</button>
</div>

<input id="globalSearch" class="search-box"
 placeholder="Search logs, dates, or conditionsâ€¦">

<div id="section-admin" class="content-section active">
  <div id="admin-container">Loading admin logsâ€¦</div>
</div>

<div id="section-weather" class="content-section">
  <div id="weather-container">Loading weather historyâ€¦</div>
</div>

</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* FIREBASE */
const adminApp = initializeApp({
  apiKey:"AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
  databaseURL:"https://administration-protal-default-rtdb.asia-southeast1.firebasedatabase.app"
},"admin");

const weatherApp = initializeApp({
  apiKey:"AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
  databaseURL:"https://report-20d26-default-rtdb.asia-southeast1.firebasedatabase.app"
},"weather");

const adminDb = getDatabase(adminApp);
const weatherDb = getDatabase(weatherApp);

let adminHistory=[], weatherHistory=[];

/* TAB SWITCH */
const secAdmin=document.getElementById("section-admin");
const secWeather=document.getElementById("section-weather");
const btnAdmin=document.getElementById("btn-admin");
const btnWeather=document.getElementById("btn-weather");

btnAdmin.onclick=()=>showTab("admin");
btnWeather.onclick=()=>showTab("weather");

function showTab(t){
  secAdmin.classList.remove("active");
  secWeather.classList.remove("active");
  btnAdmin.classList.remove("active");
  btnWeather.classList.remove("weather-active");

  if(t==="admin"){
    secAdmin.classList.add("active");
    btnAdmin.classList.add("active");
  }else{
    secWeather.classList.add("active");
    btnWeather.classList.add("weather-active");
  }
}

/* DATA */
onValue(ref(adminDb,"grant_history"),s=>{
  adminHistory=Object.values(s.val()||{}).reverse();
  renderAdmin();
});
onValue(ref(weatherDb,"weather_logs"),s=>{
  weatherHistory=Object.values(s.val()||{}).reverse();
  renderWeather();
});

/* ADMIN */
function renderAdmin(){
  const box=document.getElementById("admin-container");
  box.innerHTML="";
  if(!adminHistory.length){box.textContent="No admin logs";return;}

  const g={};
  adminHistory.forEach(h=>{
    const d=(h.timestamp||"Unknown").split(",")[0];
    (g[d]=g[d]||[]).push(h);
  });

  Object.keys(g).forEach(d=>{
    box.innerHTML+=`
    <div class="date-group">
      <div class="date-header"
        onclick="this.nextElementSibling.classList.toggle('open')">
        ğŸ“… ${d} (${g[d].length})
      </div>
      <div class="date-content">
        ${g[d].map(i=>`
          <div class="entry-card">
            <strong>${(i.timestamp||"").split(",")[1]}</strong>
            <div class="raw">${JSON.stringify(i,null,2)}</div>
          </div>`).join("")}
      </div>
    </div>`;
  });
}

/* WEATHER */
function renderWeather(){
  const box=document.getElementById("weather-container");
  box.innerHTML="";
  if(!weatherHistory.length){box.textContent="No weather records";return;}

  const g={};
  weatherHistory.forEach(w=>{
    const d=(w.timestamp_ist||"Unknown").split(",")[0];
    (g[d]=g[d]||[]).push(w);
  });

  Object.keys(g).forEach(d=>{
    box.innerHTML+=`
    <div class="date-group">
      <div class="date-header"
        onclick="this.nextElementSibling.classList.toggle('open')">
        ğŸ“… ${d}
        <button class="export-btn"
          onclick="event.stopPropagation();exportCSV('${d}')">
          Export CSV
        </button>
      </div>
      <div class="date-content">
        ${g[d].map(w=>`
        <div class="entry-card">
          <div class="entry-head"
            onclick="this.nextElementSibling.classList.toggle('open')">
            ğŸ•’ ${(w.timestamp_ist||"").split(",")[1]}
            <span class="badge" style="background:${aqiColor(w.aqi)}">
              ${w.aqi_status}
            </span>
          </div>
          <div class="entry-details">
            ğŸŒ¡ ${w.temp_c}Â°C (Feels ${w.feels_like_c}Â°C)<br>
            â˜ ${w.condition}<br>
            ğŸŒ¬ Wind ${w.wind_kmh} km/h<br>
            ğŸ’§ Humidity ${w.humidity}%<br>
            ğŸ“Š Pressure ${w.pressure_hpa} hPa<br>
            ğŸ‘ Visibility ${w.visibility_km} km<br>
            ğŸ« PM2.5 ${w.pm25}<br>
            ğŸ™ ${w.city}
          </div>
        </div>`).join("")}
      </div>
    </div>`;
  });
}

/* CSV */
window.exportCSV=date=>{
  const rows=weatherHistory.filter(w=>(w.timestamp_ist||"").startsWith(date));
  const keys=Object.keys(rows[0]);
  const csv=[keys.join(",")].concat(
    rows.map(r=>keys.map(k=>JSON.stringify(r[k]??"")).join(","))
  ).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`weather_${date}.csv`;
  a.click();
};

function aqiColor(a){
  if(a<=50)return"#10b981";
  if(a<=100)return"#facc15";
  return"#ef4444";
}
</script>
</body>
</html>
