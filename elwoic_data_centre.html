<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ELWOIC ‚Äî Admin Data Centre</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const authConfig = {
  apiKey: "AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
  authDomain: "administration-protal.firebaseapp.com"
};

const authApp = initializeApp(authConfig, "adminAuthApp");
const auth = getAuth(authApp);

onAuthStateChanged(auth, user => {
  if (!user) { window.location.replace("data_login.html"); }
});

window.logout = () => {
  signOut(auth).then(() => { window.location.replace("data_login.html"); });
};
</script>

<style>
:root {
    --bg:#f1f5f9; --panel:#ffffff; --border:#cbd5e1;
    --text:#0f172a; --muted:#64748b; --accent:#2563eb; --weather:#10b981;
}

body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); }
.container { max-width:1100px; margin:auto; padding:20px; }

.header {
    display:flex; justify-content:space-between; align-items:center;
    background:#1e293b; color:white; padding:20px; border-radius:12px; margin-bottom:10px;
}

/* ÌÉ≠ Ïä§ÌÉÄÏùº */
.tab-nav { display:flex; gap:10px; margin-bottom:20px; }
.tab-btn { 
    flex:1; padding:15px; border:none; border-radius:8px; cursor:pointer; 
    font-weight:bold; background:var(--border); color:var(--muted); transition:0.3s;
}
.tab-btn.active { background:var(--accent); color:white; }
.tab-btn.weather-active { background:var(--weather); color:white; }

.content-section { display:none; }
.content-section.active { display:block; }

.search-box { width:100%; padding:15px; border:1px solid var(--border); border-radius:8px; margin-bottom:20px; box-sizing:border-box; }

/* Weather Table Styling */
.weather-table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
.weather-table th { background:#f8fafc; padding:15px; text-align:left; border-bottom:2px solid var(--border); }
.weather-table td { padding:15px; border-bottom:1px solid var(--border); }
.weather-row:hover { background:#f1f5f9; }

.nav-btn { padding:10px 20px; border-radius:6px; border:none; background:var(--accent); color:white; font-weight:bold; cursor:pointer; }
.date-group { background:var(--panel); border:1px solid var(--border); border-radius:10px; margin-bottom:15px; overflow:hidden; }
.date-header { padding:15px 20px; background:#f8fafc; cursor:pointer; display:flex; justify-content:space-between; }
.date-content { display:none; padding:15px; }
.date-content.open { display:block; }
.entry-card { border:1px solid #e2e8f0; border-radius:8px; padding:15px; margin-bottom:10px; background:white; }
.badge { padding:4px 10px; border-radius:4px; font-size:.75rem; font-weight:bold; background:#e0e7ff; color:#3730a3; }
.raw-data-box { background:#f1f5f9; padding:10px; border-radius:5px; font-family:monospace; font-size:.75rem; white-space:pre-wrap; }
</style>
</head>

<body>
<div class="container">

    <div class="header">
        <div>
            <h1 style="margin:0">ELWOIC Admin Centre</h1>
            <small id="status-text">System Authenticated</small>
        </div>
        <button class="nav-btn" onclick="logout()">Logout</button>
    </div>

    <div class="tab-nav">
        <button id="btn-admin" class="tab-btn active" onclick="showTab('admin')">üõ†Ô∏è Admin Logs</button>
        <button id="btn-weather" class="tab-btn" onclick="showTab('weather')">üå§Ô∏è Weather History</button>
    </div>

    <input id="globalSearch" class="search-box" placeholder="Search logs, dates, or conditions...">

    <div id="section-admin" class="content-section active">
        <div id="admin-container"><p style="text-align:center;padding:50px">Syncing Admin History...</p></div>
    </div>

    <div id="section-weather" class="content-section">
        <table class="weather-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Temp</th>
                    <th>AQI</th>
                    <th>Status</th>
                    <th>Condition</th>
                </tr>
            </thead>
            <tbody id="weather-body">
                <tr><td colspan="5" style="text-align:center;padding:50px">Loading Weather Cloud Data...</td></tr>
            </tbody>
        </table>
    </div>

</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- 1. ADMIN PROJECT CONFIG ---
const adminConfig = {
    apiKey: "AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
    databaseURL: "https://administration-protal-default-rtdb.asia-southeast1.firebasedatabase.app"
};

// --- 2. WEATHER PROJECT CONFIG ---
const weatherConfig = {
    apiKey: "AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
    databaseURL: "https://report-20d26-default-rtdb.asia-southeast1.firebasedatabase.app"
};

// Initialize both apps
const adminApp = initializeApp(adminConfig, "adminApp");
const weatherApp = initializeApp(weatherConfig, "weatherApp");

// Connect to both databases
const adminDb = getDatabase(adminApp);
const weatherDb = getDatabase(weatherApp);

let adminHistory = [];
let weatherHistory = [];

// --- TAB SWITCHING ---
window.showTab = (tab) => {
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'weather-active'));
    
    if(tab === 'admin') {
        document.getElementById('section-admin').classList.add('active');
        document.getElementById('btn-admin').classList.add('active');
    } else {
        document.getElementById('section-weather').classList.add('active');
        document.getElementById('btn-weather').classList.add('weather-active');
    }
    renderAll();
};

// --- DATA LISTENERS ---
// Listen to Admin Data
onValue(ref(adminDb, "grant_history"), snap => {
    adminHistory = Object.values(snap.val() || {}).reverse();
    renderAll();
});

// Listen to Weather Data
onValue(ref(weatherDb, "weather_logs"), snap => {
    weatherHistory = Object.values(snap.val() || {}).reverse();
    renderAll();
});

document.getElementById("globalSearch").addEventListener("input", renderAll);

function renderAll() {
    const q = document.getElementById("globalSearch").value.toLowerCase();
    renderAdmin(q);
    renderWeather(q);
}

function renderAdmin(q) {
    const box = document.getElementById("admin-container");
    const filtered = adminHistory.filter(h => JSON.stringify(h).toLowerCase().includes(q));
    box.innerHTML = "";

    const grouped = {};
    filtered.forEach(h => {
        const d = (h.timestamp || "Unknown").split(',')[0];
        grouped[d] = grouped[d] || [];
        grouped[d].push(h);
    });

    Object.keys(grouped).forEach(date => {
        const div = document.createElement("div");
        div.className = "date-group";
        div.innerHTML = `
            <div class="date-header" onclick="this.nextElementSibling.classList.toggle('open')">
                <h3>üìÖ ${date}</h3>
                <span>${grouped[date].length} Logs ‚ñæ</span>
            </div>
            <div class="date-content">${grouped[date].map(item => `
                <div class="entry-card">
                    <div class="entry-top" style="display:flex;justify-content:space-between">
                        <span style="font-weight:bold">${(item.timestamp || "").split(',')[1] || "N/A"}</span>
                        <span class="badge">üõ†Ô∏è ${item.type || "Action"}</span>
                    </div>
                    <div class="raw-data-box" style="margin-top:10px">${JSON.stringify(item,null,2)}</div>
                </div>`).join("")}</div>`;
        box.appendChild(div);
    });
}

function renderWeather(q) {
    const tbody = document.getElementById("weather-body");
    const filtered = weatherHistory.filter(w => JSON.stringify(w).toLowerCase().includes(q));
    tbody.innerHTML = "";

    filtered.forEach(w => {
        const row = document.createElement("tr");
        row.className = "weather-row";
        const dateObj = new Date(w.timestamp);
        row.innerHTML = `
            <td>
                <div style="font-weight:bold">${dateObj.toLocaleTimeString()}</div>
                <div style="font-size:0.7rem;color:gray">${dateObj.toLocaleDateString()}</div>
            </td>
            <td>${w.temp || '--'}¬∞C</td>
            <td>${w.aqi || '--'}</td>
            <td><span class="badge" style="background:${getAQIColor(w.aqi)};color:white">${w.aqi_status || 'N/A'}</span></td>
            <td style="text-transform:capitalize">${w.condition || '--'}</td>`;
        tbody.appendChild(row);
    });
}

function getAQIColor(aqi) {
    if(aqi <= 50) return "#10b981";
    if(aqi <= 100) return "#facc15";
    return "#ef4444";
}
</script>
</body>
</html>
