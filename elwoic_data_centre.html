<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ELWOIC ‚Äî Admin Data Centre</title>

<!-- üîê AUTH GUARD -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const authConfig = {
    apiKey: "AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
    authDomain: "administration-protal.firebaseapp.com"
};

const authApp = initializeApp(authConfig, "authGuardApp");
const auth = getAuth(authApp);

onAuthStateChanged(auth, user => {
    if (!user) window.location.replace("data_login.html");
});

window.logout = () => {
    signOut(auth).then(() => window.location.replace("data_login.html"));
};
</script>

<style>
:root {
    --bg:#f1f5f9; --panel:#ffffff; --border:#cbd5e1;
    --text:#0f172a; --muted:#64748b; --accent:#2563eb;
}

body {
    margin:0;
    font-family:'Segoe UI',system-ui,sans-serif;
    background:var(--bg);
    color:var(--text);
}

.container {
    max-width:1100px;
    margin:auto;
    padding:20px;
}

.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#1e293b;
    color:white;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
}

.nav-btn {
    padding:10px 20px;
    border-radius:6px;
    border:none;
    background:var(--accent);
    color:white;
    font-weight:bold;
}

.search-box {
    width:100%;
    padding:15px;
    border:1px solid var(--border);
    border-radius:8px;
    margin-bottom:20px;
    font-size:1rem;
}

.date-group {
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:10px;
    margin-bottom:15px;
    overflow:hidden;
    box-shadow:0 4px 6px -1px rgba(0,0,0,.1);
}

.date-header {
    padding:15px 20px;
    background:#f8fafc;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    border-bottom:1px solid var(--border);
}

.date-header h3 {
    margin:0;
    font-size:1.1rem;
    color:var(--accent);
}

.date-content { display:none; padding:15px; }
.date-content.open { display:block; }

.entry-card {
    border:1px solid #e2e8f0;
    border-radius:8px;
    padding:15px;
    margin-bottom:15px;
    background:white;
}

.entry-top {
    display:flex;
    justify-content:space-between;
    border-bottom:1px dashed #e2e8f0;
    padding-bottom:8px;
    margin-bottom:10px;
}

.time-label { font-weight:bold; color:#334155; }

.badge {
    padding:4px 10px;
    border-radius:4px;
    font-size:.75rem;
    font-weight:bold;
    background:#fee2e2;
    color:#991b1b;
}

.raw-data-title {
    font-size:.7rem;
    font-weight:bold;
    text-transform:uppercase;
    color:var(--muted);
    margin-top:10px;
    display:block;
}

.raw-data-box {
    background:#f1f5f9;
    padding:10px;
    border-radius:5px;
    font-family:Consolas,monospace;
    font-size:.75rem;
    border:1px solid #e2e8f0;
    max-height:200px;
    overflow:auto;
    white-space:pre-wrap;
}
</style>
</head>

<body>
<div class="container">

<div class="header">
    <div>
        <h1 style="margin:0">ELWOIC Admin Data Centre</h1>
        <small>Complete Administrative Transparency</small>
    </div>
    <button class="nav-btn" onclick="logout()">Logout</button>
</div>

<input id="globalSearch" class="search-box"
placeholder="Search admin actions, names, IDs, timestamps‚Ä¶">

<div id="data-container">
    <p style="text-align:center;padding:50px">
        Syncing Admin History‚Ä¶
    </p>
</div>

</div>

<!-- üìä ADMIN HISTORY ONLY -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const config = {
    apiKey: "AIzaSyALWX2l-9_6izgvt_JerJjTDbgNc5oT2VQ",
    databaseURL: "https://administration-protal-default-rtdb.asia-southeast1.firebasedatabase.app"
};

const app = initializeApp(config);
const db = getDatabase(app);

let history = [];

onValue(ref(db, "grant_history"), snap => {
    history = Object.values(snap.val() || {}).reverse();
    render();
});

document.getElementById("globalSearch").addEventListener("input", render);

function render() {
    const box = document.getElementById("data-container");
    const q = document.getElementById("globalSearch").value.toLowerCase();
    box.innerHTML = "";

    const filtered = history.filter(h =>
        JSON.stringify(h).toLowerCase().includes(q)
    );

    const grouped = {};
    filtered.forEach(h => {
        const d = (h.timestamp || "Unknown").split(',')[0];
        grouped[d] = grouped[d] || [];
        grouped[d].push(h);
    });

    Object.keys(grouped).forEach(date => {
        const div = document.createElement("div");
        div.className = "date-group";
        div.innerHTML = `
            <div class="date-header"
                 onclick="this.nextElementSibling.classList.toggle('open')">
                <h3>üìÖ ${date}</h3>
                <span>${grouped[date].length} Logs ‚ñæ</span>
            </div>
            <div class="date-content">
                ${grouped[date].map(renderEntry).join("")}
            </div>`;
        box.appendChild(div);
    });
}

function renderEntry(item) {
    const time = (item.timestamp || "").split(',')[1] || "N/A";
    return `
    <div class="entry-card">
        <div class="entry-top">
            <span class="time-label">${time}</span>
            <span class="badge">üõ†Ô∏è ${item.type || "Action"}</span>
        </div>
        <span class="raw-data-title">Full Firebase Record</span>
        <div class="raw-data-box">${JSON.stringify(item,null,4)}</div>
    </div>`;
}
</script>

</body>
</html>
