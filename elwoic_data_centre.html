<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elamkulam Weather & Air Station</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h2 { margin: 0 0 20px 0; font-size: 1.4rem; color: var(--dark); border-left: 4px solid var(--primary); padding-left: 15px; }
        
        /* Stats Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; }
        .stat-box { background: #fff; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; transition: transform 0.2s; }
        .stat-box:hover { transform: translateY(-5px); }
        .stat-box small { color: #6c757d; display: block; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 8px; }
        .stat-box span { font-size: 1.3rem; font-weight: 700; color: var(--dark); }
        
        /* AQI Specific Styling */
        .aqi-value { font-size: 2rem !important; display: block; margin-top: 5px; }
        .status-good { color: #00af50 !important; }
        .status-moderate { color: #ffde33 !important; }
        .status-poor { color: #ff9900 !important; }

        /* Table Styling */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8f9fa; color: #6c757d; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #f1f1f1; font-size: 0.9rem; }
        tr:hover { background-color: #fcfcfc; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; background: #e9ecef; }
        .status-tag { font-size: 0.8rem; background: var(--success); color: white; padding: 5px 12px; border-radius: 50px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Elamkulam Station</h1>
        <span id="sync-status" class="status-tag">Live Sync Active</span>
    </div>

    <div class="card">
        <h2>Current Weather</h2>
        <div class="grid">
            <div class="stat-box"><small>Temp</small><span id="curr-temp">--</span>°C</div>
            <div class="stat-box"><small>Feels Like</small><span id="curr-feels">--</span>°C</div>
            <div class="stat-box"><small>Humidity</small><span id="curr-hum">--</span>%</div>
            <div class="stat-box"><small>Visibility</small><span id="curr-vis">--</span> km</div>
            <div class="stat-box"><small>Wind</small><span id="curr-wind">--</span> km/h</div>
            <div class="stat-box"><small>Sky</small><span id="curr-cond">--</span></div>
        </div>
    </div>

    <div class="card">
        <h2>Air Quality Index (AQI)</h2>
        <div class="grid">
            <div class="stat-box" style="grid-column: span 2;">
                <small>Health Status</small>
                <span id="curr-aqi-status" class="aqi-value">Loading...</span>
            </div>
            <div class="stat-box"><small>AQI Level</small><span id="curr-aqi-num">--</span></div>
            <div class="stat-box"><small>PM2.5</small><span id="curr-pm25">--</span> µg/m³</div>
        </div>
    </div>

    <div class="card">
        <h2>Hourly History</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Temp / Feels</th>
                        <th>Sky</th>
                        <th>AQI Status</th>
                        <th>Wind</th>
                        <th>Visibility</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <tr><td colspan="6">Waiting for data from Firebase...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDo3Rm9PBZ8GZqOucYh1VyCCc3hBPLbTn4",
        authDomain: "report-20d26.firebaseapp.com",
        databaseURL: "https://report-20d26-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "report-20d26",
        storageBucket: "report-20d26.firebasestorage.app",
        messagingSenderId: "293755368519",
        appId: "1:293755368519:web:a41877cad54a65f93c2d62"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Fetch the last 24 logs
    const recentLogsQuery = query(ref(db, 'weather_logs'), limitToLast(24));

    onValue(recentLogsQuery, (snapshot) => {
        const tableBody = document.getElementById("history-table-body");
        const data = snapshot.val();
        
        if (!data) {
            tableBody.innerHTML = "<tr><td colspan='6'>No records found in database.</td></tr>";
            return;
        }

        const logs = Object.values(data).reverse();
        const latest = logs[0];

        // 1. Update Current Weather UI
        document.getElementById("curr-temp").textContent = latest.weather.temp;
        document.getElementById("curr-feels").textContent = latest.weather.feels_like;
        document.getElementById("curr-hum").textContent = latest.weather.humidity;
        document.getElementById("curr-vis").textContent = latest.weather.visibility_km;
        document.getElementById("curr-wind").textContent = latest.weather.wind_kmh;
        document.getElementById("curr-cond").textContent = latest.weather.condition;

        // 2. Update Current AQI UI
        document.getElementById("curr-aqi-status").textContent = latest.air_quality.status;
        document.getElementById("curr-aqi-num").textContent = latest.air_quality.aqi;
        document.getElementById("curr-pm25").textContent = latest.air_quality.pm2_5;

        // 3. Populate History Table
        tableBody.innerHTML = "";
        logs.forEach(log => {
            const row = `<tr>
                <td><strong>${log.time.split(',')[1] || log.time}</strong><br><small>${log.time.split(',')[0]}</small></td>
                <td>${log.weather.temp}°C <br><small>Feels ${log.weather.feels_like}°C</small></td>
                <td><span class="badge">${log.weather.condition}</span></td>
                <td><strong>${log.air_quality.status}</strong><br><small>AQI: ${log.air_quality.aqi}</small></td>
                <td>${log.weather.wind_kmh} km/h</td>
                <td>${log.weather.visibility_km} km</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
        
        document.getElementById("sync-status").textContent = "Updated: " + new Date().toLocaleTimeString();
    });
</script>

</body>
</html>
