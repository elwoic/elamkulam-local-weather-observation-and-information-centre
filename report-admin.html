<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ELWOIC — Weather Report Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    .report-photo-thumb {
        max-height: 120px;
        width: auto;
        border-radius: 4px;
        margin-top: 8px;
        object-fit: cover;
    }
    .input-edit {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 0.95rem;
        width: 100%;
        margin-top: 3px;
    }
    .grant-btn {
        background-color: #16a34a;
        color: white;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        margin-top: 6px;
        cursor: pointer;
    }
    .grant-btn:hover { background-color: #15803d; }
</style>
</head>

<body class="bg-slate-50 min-h-screen font-sans">

<header class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-10">
    <div class="container mx-auto flex items-center justify-between">
        <div>
            <h1 class="text-lg md:text-2xl font-bold">ELWOIC Admin: Weather Reports</h1>
            <p class="text-xs opacity-80">Realtime community weather observation viewer</p>
        </div>
        <div class="space-x-2">
            <a href="report.html" class="px-3 py-2 bg-white text-blue-900 rounded shadow-sm text-sm hover:bg-slate-200">
                ← Back to Submission
            </a>
        </div>
    </div>
</header>

<main class="container mx-auto px-4 py-8">
    <div id="status" class="mb-4 p-3 rounded text-sm bg-blue-100 text-blue-800">Initializing...</div>
    <div id="messagesList" class="space-y-4"></div>
    <div id="empty" class="hidden text-center p-8 bg-white rounded shadow border-dashed border-2 border-gray-300">
        <p class="text-gray-600">No weather reports found in the database.</p>
    </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyASblrFKqSUK6heHly2Bh95EJ_Gqmx0XVQ",
    authDomain: "report-5d8c0.firebaseapp.com",
    databaseURL: "https://report-5d8c0-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "report-5d8c0",
    storageBucket: "report-5d8c0.firebasestorage.app",
    messagingSenderId: "831456060916",
    appId: "1:831456060916:web:1e06b9d3897dd9637305a1"
};

const VALID_PASSPHRASES = ["04933", "elwoic811", "elwoic822"];
const DB_PATH = "weather_reports"; 
const USER_REPORTS_PATH = "user_reports";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const statusEl = document.getElementById('status');
const messagesList = document.getElementById('messagesList');
const emptyEl = document.getElementById('empty');

let currentData = [];

// Admin Password
let allowed = false;
const entered = prompt("Enter admin password to view reports:"); 
if (VALID_PASSPHRASES.includes(entered)) allowed = true;

if (!allowed) {
    statusEl.textContent = "Access denied — incorrect password.";
    statusEl.className = "mb-4 p-3 rounded text-sm bg-red-100 text-red-800";
    messagesList.style.display = "none";
    setTimeout(() => { window.location.href = "report.html"; }, 3000); 
} else {
    startListening();
}

// --- FUNCTIONS ---
function setStatus(text, type="info") {
    statusEl.textContent = text;
    statusEl.className = "mb-4 p-3 rounded text-sm";
    if(type==="info") statusEl.classList.add("bg-blue-100","text-blue-800");
    if(type==="success") statusEl.classList.add("bg-green-100","text-green-800");
    if(type==="error") statusEl.classList.add("bg-red-100","text-red-800");
}

function startListening() {
    setStatus("Connecting to Firebase...");
    const reportsRef = ref(db, DB_PATH);

    onValue(reportsRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) {
            currentData = [];
            messagesList.innerHTML = "";
            emptyEl.classList.remove("hidden");
            setStatus("No reports found.", "info");
            return;
        }

        currentData = Object.entries(data).map(([key, v]) => ({ key, ...v }));
        currentData.sort((a,b)=> (b.timestamp || 0) - (a.timestamp || 0));
        render(currentData);
        setStatus(`Loaded ${currentData.length} report(s).`, "success");
    });
}

function render(list) {
    messagesList.innerHTML = "";
    if(list.length===0) { emptyEl.classList.remove("hidden"); return; }
    emptyEl.classList.add("hidden");

    list.forEach(item => {
        const d = item.timestamp ? new Date(item.timestamp).toLocaleString() : "N/A";
        const showOnSite = item.show_on_site || "no";
        const showName = item.show_name || "no";

        const card = document.createElement("div");
        card.className = "bg-white p-4 md:p-6 rounded-lg shadow border-l-4 border-red-600";

        card.innerHTML = `
            <div class="flex flex-col gap-2">
                <h3 class="text-lg font-semibold text-red-700">${escape(item.report_type)} Report</h3>
                <span class="text-xs text-slate-500">Submitted: ${d} | Event Time: <input class="input-edit" value="${escape(item.time)}" id="time-${item.key}"></span>
                
                <p class="text-sm text-slate-600 mt-2">
                    <strong>Location:</strong> ${escape(item.location)}
                </p>
                <p class="text-sm text-slate-600">
                    <strong>Reporter:</strong> <input class="input-edit" value="${escape(item.name)}" id="name-${item.key}">
                    ${item.email ? `— <a href="mailto:${escape(item.email)}" class="text-blue-700">${escape(item.email)}</a>` : ''}
                </p>

                <p class="mt-3 text-slate-800 whitespace-pre-wrap font-medium">
                    <textarea class="input-edit" id="obs-${item.key}" rows="3">${escape(item.observation)}</textarea>
                </p>

                <p><strong>Report Type:</strong>
                    <select class="input-edit" id="type-${item.key}">
                        <option ${item.report_type==="Rainfall"?"selected":""}>Rainfall</option>
                        <option ${item.report_type==="Flood / Water Level"?"selected":""}>Flood / Water Level</option>
                        <option ${item.report_type==="Storm / Wind"?"selected":""}>Storm / Wind</option>
                        <option ${item.report_type==="Lightning"?"selected":""}>Lightning</option>
                        <option ${item.report_type==="Road Block / Tree Fall"?"selected":""}>Road Block / Tree Fall</option>
                        <option ${item.report_type==="General Information"?"selected":""}>General Information</option>
                        <option ${item.report_type==="Other"?"selected":""}>Other</option>
                    </select>
                </p>

                <p><strong>Show on site:</strong> ${showOnSite} | <strong>Show Name:</strong> ${showName}</p>
                
                ${item.photo_url && item.photo_url!=="N/A" ? `<a href="${escape(item.photo_url)}" target="_blank"><img src="${escape(item.photo_url)}" class="report-photo-thumb"></a>` : ''}
<div class="flex gap-2 mt-2">
    ${showOnSite==="yes" ? `<button class="grant-btn" id="grant-${item.key}">Grant</button>` : `<span class="text-red-600 font-semibold">Not allowed to show</span>`}
    <button class="revokeBtn px-3 py-2 bg-gray-700 text-white rounded text-sm hover:bg-gray-800" id="revoke-${item.key}">Revoke</button>
    <button class="deleteBtn px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700" id="del-${item.key}">Delete</button>
</div>

              
            </div>
        `;

        messagesList.appendChild(card);

        // DELETE
        document.getElementById(`del-${item.key}`).onclick = async () => {
            if(confirm("Permanently delete this report?")) {
                await remove(ref(db, DB_PATH + "/" + item.key));
                setStatus("Report deleted.", "success");
            }
        };
// GRANT
if (showOnSite === "yes") {
    document.getElementById(`grant-${item.key}`).onclick = async () => {
        const obs = document.getElementById(`obs-${item.key}`).value.trim();
        const nm = showName === "yes" ? document.getElementById(`name-${item.key}`).value.trim() : "Anonymous";
        const timeVal = document.getElementById(`time-${item.key}`).value.trim();
        const typeVal = document.getElementById(`type-${item.key}`).value;

        const newGrant = await push(ref(db, USER_REPORTS_PATH), {
            name: nm,
            location: item.location,
            report_type: typeVal,
            observation: obs,
            time: timeVal,
            photo_url: item.photo_url || "N/A",
            timestamp: item.timestamp,          // << match with report
            expiresAt: Date.now() + (24 * 60 * 60 * 1000)
        });

        setStatus("Report granted to site ✔", "success");

        document.getElementById(`grant-${item.key}`).innerText = "Granted ✓";
        document.getElementById(`grant-${item.key}`).disabled = true;
        document.getElementById(`grant-${item.key}`).style.opacity = "0.6";
    };
}

// REVOKE
document.getElementById(`revoke-${item.key}`).onclick = async () => {
    const grantedRef = ref(db, USER_REPORTS_PATH);
    onValue(grantedRef, async (snap) => {
        const granted = snap.val();
        if (!granted) return;

        for (const [k, v] of Object.entries(granted)) {
            if (v.timestamp === item.timestamp) {
                await remove(ref(db, USER_REPORTS_PATH + "/" + k));
                setStatus("Grant revoked ❌", "error");
                break;
            }
        }
    }, { onlyOnce: true });
};

     
function escape(s) {
    if(!s) return "";
    return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
}
</script>

</body>
</html>
