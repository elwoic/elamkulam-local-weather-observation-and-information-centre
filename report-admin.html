<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ELWOIC — Weather Report Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .report-photo-thumb { max-height: 120px; width: auto; border-radius: 4px; margin-top: 8px; object-fit: cover; }
  .input-edit { border: 1px solid #ccc; border-radius: 4px; padding: 4px 6px; font-size: 0.95rem; width: 100%; margin-top: 3px; }
  .grant-btn { background-color: #16a34a; color: white; padding: 6px 10px; border-radius: 5px; font-size: 0.85rem; margin-top: 6px; cursor: pointer; }
  .grant-btn:hover { background-color: #15803d; }
  .revoke-btn { background-color: #ef4444; color: white; padding: 6px 10px; border-radius: 5px; font-size: 0.85rem; cursor: pointer; }
  .revoke-btn:hover { background-color: #b91c1c; }
</style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

<header class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-10">
  <div class="container mx-auto flex items-center justify-between">
    <div>
      <h1 class="text-lg md:text-2xl font-bold">ELWOIC Admin: Weather Reports</h1>
      <p class="text-xs opacity-80">Realtime community weather observation viewer</p>
    </div>
    <div class="space-x-2">
      <a href="report.html" class="px-3 py-2 bg-white text-blue-900 rounded shadow-sm text-sm hover:bg-slate-200">← Back to Submission</a>
    </div>
  </div>
</header>

<div id="loginContainer" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-sm">
    <h2 class="text-xl font-bold mb-4">Admin Login</h2>
    <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded mb-3">
    <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded mb-4">
    <button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Login</button>
    <p id="loginMessage" class="text-red-600 mt-2 hidden"></p>
  </div>
</div>

<main id="reportContainer" class="hidden">
  <div id="status" class="mb-4 p-3 rounded text-sm bg-blue-100 text-blue-800">Initializing...</div>
  <div id="messagesList" class="space-y-4"></div>
  <div id="empty" class="hidden text-center p-8 bg-white rounded shadow border-dashed border-2 border-gray-300">
    <p class="text-gray-600">No weather reports found in the database.</p>
  </div>
</main>

<script type="module">
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyASblrFKqSUK6heHly2Bh95EJ_Gqmx0XVQ",
  authDomain: "report-5d8c0.firebaseapp.com",
  databaseURL: "https://report-5d8c0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "report-5d8c0",
  storageBucket: "report-5d8c0.firebasestorage.app",
  messagingSenderId: "831456060916",
  appId: "1:831456060916:web:1e06b9d3897dd9637305a1",
  measurementId: "G-5MGMM1DYDM"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// 2️⃣ **Add these lines here**
const loginContainer = document.getElementById("loginContainer");
const reportContainer = document.getElementById("reportContainer");
const loginBtn = document.getElementById("loginBtn");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginMessage = document.getElementById("loginMessage");

const statusEl = document.getElementById("status");
const messagesList = document.getElementById("messagesList");
const emptyEl = document.getElementById("empty");


loginBtn.addEventListener("click", () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value;

  signInWithEmailAndPassword(auth, email, password)
    .then((userCredential) => {
      loginContainer.style.display = "none";
      reportContainer.classList.remove("hidden");
      startListening(); // Call your Firebase DB listener after login
    })
    .catch((error) => {
      loginMessage.textContent = error.message;
      loginMessage.classList.remove("hidden");
    });
});


// Optional: auto-logout after closing session or refresh
onAuthStateChanged(auth, (user) => {
  if (user) {
    loginContainer.style.display = "none";
    reportContainer.classList.remove("hidden");
    startListening(); // Load reports
  } else {
    loginContainer.style.display = "flex";
    reportContainer.classList.add("hidden");
  }
});
const DB_PATH = "weather_reports"; // replace with the actual path in your Firebase DB



function setStatus(text, type="info") {
  statusEl.textContent = text;
  statusEl.className = "mb-4 p-3 rounded text-sm";
  if(type==="info") statusEl.classList.add("bg-blue-100","text-blue-800");
  if(type==="success") setTimeout(()=>{statusEl.textContent=text; statusEl.className="mb-4 p-3 rounded text-sm bg-green-100 text-green-800"}, 0);
  if(type==="error") statusEl.classList.add("bg-red-100","text-red-800");
}

function startListening() {
  setStatus("Connecting to Firebase...");
  const reportsRef = ref(db, DB_PATH);

  onValue(reportsRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) {
      messagesList.innerHTML = "";
      emptyEl.classList.remove("hidden");
      setStatus("No reports found.", "info");
      return;
    }
    emptyEl.classList.add("hidden");

    const reports = Object.entries(data).map(([key, v]) => ({ key, ...v }));
    reports.sort((a,b)=> (b.timestamp || 0) - (a.timestamp || 0));
    render(reports);
    setStatus(`Loaded ${reports.length} report(s).`, "success");
  });
}

// ... (Firebase imports and config remain the same) ...

// ... (setStatus, startListening functions remain the same) ...

function render(list) {
    messagesList.innerHTML = "";
    list.forEach(item => {
        const d = item.timestamp ? new Date(item.timestamp).toLocaleString() : "N/A";
        
        // Use new fields for status checks
        const granted1 = item.granted_site1 === "yes";
        const granted2 = item.granted_site2 === "yes";
        
        // Check user's permission to display the report on the site
        const userAllowsReportDisplay = item.show_on_site === "yes";

        // Calculate the current expiration status for display
        const expirationTime = item.expirationTimestamp ? new Date(item.expirationTimestamp).toLocaleString() : 'Never Set';
        const isExpired = item.expirationTimestamp && item.expirationTimestamp < Date.now();
        const expirationText = isExpired ? 
            `<span class="text-red-600 font-semibold">Expired: ${expirationTime}</span>` : 
            `Expires: ${expirationTime}`;

        const card = document.createElement("div");
        card.className = `bg-white p-4 md:p-6 rounded-lg shadow border-l-4 ${userAllowsReportDisplay ? 'border-blue-600' : 'border-red-600'}`;

        card.innerHTML = `
          <div class="flex flex-col gap-2">
            <h3 class="text-lg font-semibold text-red-700">${escape(item.report_type)} Report</h3>
            <span class="text-xs text-slate-500">Submitted: ${d} | Event Time: <input class="input-edit" value="${escape(item.time)}" id="time-${item.key}"></span>
            <p class="text-sm text-slate-600 mt-2"><strong>Location:</strong> ${escape(item.location)}</p>
            <p class="text-sm text-slate-600"><strong>Reporter:</strong> <input class="input-edit" value="${escape(item.name)}" id="name-${item.key}"></p>
            <p class="mt-3 text-slate-800 whitespace-pre-wrap font-medium"><textarea class="input-edit" id="obs-${item.key}" rows="3">${escape(item.observation)}</textarea></p>
            
            <div class="text-sm mt-2 flex justify-between items-center flex-wrap">
                <div>
                    <strong>User Permission:</strong> 
                    <span class="font-semibold ${userAllowsReportDisplay ? 'text-green-600' : 'text-red-600'}">
                        Show Report: ${userAllowsReportDisplay ? '✅ Yes' : '❌ No'}
                    </span>
                    <span class="ml-4 font-semibold ${item.show_name === 'yes' ? 'text-green-600' : 'text-red-600'}">
                        Show Name: ${item.show_name === 'yes' ? '✅ Yes' : '❌ No'}
                    </span>
                </div>
                
                <div class="mt-2 md:mt-0">
                    <strong class="mr-2">Duration (Hours):</strong> 
                    <input type="number" min="1" value="24" class="input-edit w-20 inline-block p-1" id="duration-${item.key}">
                </div>
            </div>

            <p class="text-xs text-slate-500">${expirationText}</p>

            ${item.photo_url && item.photo_url!=="N/A" ? `<a href="${escape(item.photo_url)}" target="_blank"><img src="${escape(item.photo_url)}" class="report-photo-thumb"></a>` : ''}
            
            <div class="flex flex-wrap gap-3 mt-2 items-center">
                <span class="text-xs font-semibold p-1 rounded ${granted1 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                    Site 1: ${granted1 ? '✅ Granted' : '❌ Not Granted'}
                </span>
                <span class="text-xs font-semibold p-1 rounded ${granted2 ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500'}">
                    Site 2: ${granted2 ? '✅ Granted' : '❌ Not Granted'}
                </span>
            </div>

            <div id="btn-container-${item.key}" class="flex gap-2 mt-3 flex-wrap">
                </div>
          </div>
        `;

        messagesList.appendChild(card);

        // Helper function remains the same
        const getEditedValues = (key) => ({
            time: document.getElementById(`time-${key}`).value,
            name: document.getElementById(`name-${key}`).value,
            observation: document.getElementById(`obs-${key}`).value,
        });
        
        // --- UPDATED: Toggle Button Creator Function ---
        const createGrantRevokeButton = (siteNum, isGranted, key, color) => {
            const btn = document.createElement('button');
            const grantField = `granted_site${siteNum}`;
            
            if (isGranted) {
                // If granted, show Revoke button
                btn.textContent = `Revoke Site ${siteNum}`;
                btn.className = 'revoke-btn'; // Uses default revoke color
                btn.onclick = async () => {
                    // When revoking, remove the specific grant field but leave expiration
                    await update(ref(db, DB_PATH + "/" + key), { [grantField]: "no" });
                    setStatus(`Report revoked from Site ${siteNum} ❌`, "info");
                };
            } else {
                // If not granted, show Grant button
                btn.textContent = `Grant Site ${siteNum}`;
                btn.className = `grant-btn ${color}`; 
                btn.onclick = async () => {
                    const updatedData = getEditedValues(key);
                    const durationInput = document.getElementById(`duration-${key}`).value;
                    const durationMs = parseInt(durationInput) * 60 * 60 * 1000; // Convert hours to milliseconds
                    
                    updatedData[grantField] = "yes"; 
                    updatedData.expirationTimestamp = Date.now() + durationMs; // Calculate expiration
                    
                    // Enforce Anonymous if user requested 'Show Name: No'
                    if (item.show_name !== 'yes') {
                         updatedData.name = "Anonymous";
                    }
                    
                    await update(ref(db, DB_PATH + "/" + key), updatedData);
                    setStatus(`Report granted to Site ${siteNum} (Expires in ${durationInput}h) and edits saved ✔`, "success");
                };
            }
            return btn;
        };
        
        // --- DELETE HANDLER (Moved into a reusable function) ---
        const createDeleteButton = (key) => {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = "delete-btn px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700";
            deleteBtn.textContent = "Delete";
            deleteBtn.onclick = async () => {
                if (confirm("Permanently delete this report?")) {
                  await remove(ref(db, DB_PATH + "/" + key));
                  setStatus("Report deleted.", "success");
                }
            };
            return deleteBtn;
        };


        const btnContainer = document.getElementById(`btn-container-${item.key}`);
        
      if (!userAllowsReportDisplay) {
    btnContainer.innerHTML = `
        <div class="p-3 bg-red-50 text-red-700 rounded-md font-medium text-sm w-full">
            ❌ User denied permission. This report cannot be displayed on the website.
        </div>
    `;
    btnContainer.appendChild(createDeleteButton(item.key));
    return; // STOP — do not show any grant buttons
}

btnContainer.appendChild(createGrantRevokeButton(1, granted1, item.key, ''));
btnContainer.appendChild(createGrantRevokeButton(2, granted2, item.key, '!bg-indigo-600 hover:!bg-indigo-700'));
btnContainer.appendChild(createDeleteButton(item.key));

    });
}

function escape(s) {
  if (!s) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
</script>
</body>
</html>
