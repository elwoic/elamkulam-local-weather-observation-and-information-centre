<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ELWOIC ‚Äî Weather Report Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .report-photo-thumb { max-height: 120px; width: auto; border-radius: 4px; margin-top: 8px; object-fit: cover; }
  .input-edit { border: 1px solid #ccc; border-radius: 4px; padding: 4px 6px; font-size: 0.95rem; width: 100%; margin-top: 3px; }
  .grant-btn { background-color: #16a34a; color: white; padding: 6px 10px; border-radius: 5px; font-size: 0.85rem; margin-top: 6px; cursor: pointer; }
  .grant-btn:hover { background-color: #15803d; }
  .revoke-btn { background-color: #ef4444; color: white; padding: 6px 10px; border-radius: 5px; font-size: 0.85rem; cursor: pointer; }
  .revoke-btn:hover { background-color: #b91c1c; }
</style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

<header class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-10">
  <div class="container mx-auto flex items-center justify-between">
    <div>
      <h1 class="text-lg md:text-2xl font-bold">ELWOIC Admin: Weather Reports</h1>
      <p class="text-xs opacity-80">Realtime community weather observation viewer</p>
    </div>
    <div class="flex space-x-2">
      <a href="report.html" class="px-3 py-2 bg-white text-blue-900 rounded shadow-sm text-sm hover:bg-slate-200">‚ÜêGo to Submission page</a>
      <button id="logoutBtn" class="px-3 py-2 bg-red-600 text-white rounded shadow-sm text-sm hover:bg-red-700 hidden">Logout</button>
    </div>
  </div>
</header>

<div id="loginContainer" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-sm">
    <h2 class="text-xl font-bold mb-4">Admin Login</h2>
    <input type="email" id="email" placeholder="Email" class="w-full p-3 border rounded mb-3">
    <input type="password" id="password" placeholder="Password" class="w-full p-3 border rounded mb-4">
    <button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Login</button>
    <p id="loginMessage" class="text-red-600 mt-2 hidden"></p>
  </div>
</div>
<main id="reportContainer" class="hidden px-4 py-6 container mx-auto">
  
  <div class="mb-6">
    <input type="text" id="searchInput" placeholder="Search by name, email, or #ID (e.g. 102)..." 
           class="w-full p-4 rounded-lg border-2 border-blue-200 shadow-sm focus:border-blue-500 outline-none transition-all">
  </div>

  <div id="summaryBox" class="mb-4 p-4 bg-white rounded-lg shadow-sm border border-blue-200 text-sm text-slate-700 leading-relaxed">
    Loading summary...
  </div>

  <div id="status" class="mb-4 p-3 rounded text-sm bg-blue-100 text-blue-800">Initializing...</div>
  
  <div id="messagesList" class="space-y-4"></div>
  <div id="empty" class="hidden text-center p-8 bg-white rounded shadow border-dashed border-2 border-gray-300">
    <p class="text-gray-600">No weather reports found in the database.</p>
  </div>
 
</main>

<script type="module">
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyASblrFKqSUK6heHly2Bh95EJ_Gqmx0XVQ",
  authDomain: "report-5d8c0.firebaseapp.com",
  databaseURL: "https://report-5d8c0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "report-5d8c0",
  storageBucket: "report-5d8c0.firebasestorage.app",
  messagingSenderId: "831456060916",
  appId: "1:831456060916:web:1e06b9d3897dd9637305a1",
  measurementId: "G-5MGMM1DYDM"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);


/* =========================================================
   BRIDGE FIREBASE (weather-report-66bdf)
========================================================= */
const bridgeConfig = {
  apiKey: "AIzaSyD1aZw3jvnMAzt6enCG6_DGkxaSQqg2NlA",
  authDomain: "weather-report-66bdf.firebaseapp.com",
  databaseURL: "https://weather-report-66bdf-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "weather-report-66bdf",
  storageBucket: "weather-report-66bdf.firebasestorage.app",
  messagingSenderId: "599939260562",
  appId: "1:599939260562:web:a0fbf532279a191559864b"
};

const bridgeApp = initializeApp(bridgeConfig, "bridgeApp");
const bridgeDB = getDatabase(bridgeApp);

const loginContainer = document.getElementById("loginContainer");
const reportContainer = document.getElementById("reportContainer");
const loginBtn = document.getElementById("loginBtn");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginMessage = document.getElementById("loginMessage");
const statusEl = document.getElementById("status");
const messagesList = document.getElementById("messagesList");
const emptyEl = document.getElementById("empty");
const logoutBtn = document.getElementById("logoutBtn");

// --- SEARCH & DATA STORAGE ---
let allReports = []; 
const searchInput = document.getElementById("searchInput");
const DB_PATH = "weather_reports";

if(searchInput) {
    searchInput.addEventListener("input", updateDashboard);
}

loginBtn.addEventListener("click", () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  signInWithEmailAndPassword(auth, email, password)
    .then(() => {
      loginContainer.style.display = "none";
      reportContainer.classList.remove("hidden");
      startListening();
    })
    .catch((error) => {
      loginMessage.textContent = error.message;
      loginMessage.classList.remove("hidden");
    });
});

onAuthStateChanged(auth, (user) => {
  if (user) {
    loginContainer.style.display = "none";
    reportContainer.classList.remove("hidden");
    logoutBtn.classList.remove("hidden"); // Show logout when logged in
    startListening();
  } else {
    loginContainer.style.display = "flex";
    reportContainer.classList.add("hidden");
    logoutBtn.classList.add("hidden"); // Hide logout when logged out
    messagesList.innerHTML = ""; // Clear list on logout
  }
});

  function setStatus(text, type="info") {

  statusEl.textContent = text;

  statusEl.className = "mb-4 p-3 rounded text-sm";

  if(type==="info") statusEl.classList.add("bg-blue-100","text-blue-800");

  if(type==="success") statusEl.classList.add("bg-green-100","text-green-800");

  if(type==="error") statusEl.classList.add("bg-red-100","text-red-800");

}
function startListening() {
  setStatus("Connecting to Firebase...");
  const reportsRef = ref(db, DB_PATH);
  const bridgeRef = ref(bridgeDB, DB_PATH);

  // We listen to the main DB, then look up the Bridge DB for each item
  onValue(reportsRef, (snapshot) => {
    const reportData = snapshot.val() || {};

    onValue(bridgeRef, (bridgeSnap) => {
      const bridgeData = bridgeSnap.val() || {};

      allReports = Object.entries(reportData).map(([key, v]) => {
        return {
          key,
          ...v,
          ...(bridgeData[key] || {}) // Merges bridge status (granted/expired)
        };
      }).reverse();

      updateDashboard();
      setStatus(`Updated: ${allReports.length} reports loaded.`, "success");
    });
  });
}

function updateDashboard() {
  const searchTerm = (searchInput.value || "").toLowerCase().trim();

  const filtered = allReports.filter(item => {
    const hId = String(item.humanId || "");
    const name = (item.name || "").toLowerCase();
    const email = (item.email || "").toLowerCase();
    return hId.includes(searchTerm) || name.includes(searchTerm) || email.includes(searchTerm);
  });

  // RESTORED SUMMARY BOX LOGIC
  const total = allReports.length;
  const urgentCount = allReports.filter(r => r.priority === 'urgent').length;
  const normalCount = total - urgentCount;
  const grantedSite1 = allReports.filter(r => r.granted_site1 === 'yes').length;
  const grantedSite2 = allReports.filter(r => r.granted_site2 === 'yes').length;
  const userDenied = allReports.filter(r => r.show_on_site !== 'yes').length;

  document.getElementById("summaryBox").innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <div>
        <p>üìä <strong>Total:</strong> ${total} (${urgentCount} urgent, ${normalCount} normal)</p>
        <p>üö´ <strong>User Denied:</strong> ${userDenied} hidden</p>
      </div>
      <div>
        <p>üåê <strong>Live:</strong> Site 1: ${grantedSite1} | Site 2: ${grantedSite2}</p>
        <p>üîç <strong>Search:</strong> ${filtered.length} matches</p>
      </div>
    </div>
  `;

  if (filtered.length === 0) {
    messagesList.innerHTML = "";
    emptyEl.classList.remove("hidden");
  } else {
    emptyEl.classList.add("hidden");
    render(filtered);
  }
}

function render(list) {
    messagesList.innerHTML = "";
    list.forEach(item => {
        const hId = item.humanId || "???"; 
        const d = item.timestamp ? (isNaN(item.timestamp) ? item.timestamp : new Date(item.timestamp).toLocaleString()) : "N/A";
        const granted1 = item.granted_site1 === "yes";
        const granted2 = item.granted_site2 === "yes";
        const userAllowsReportDisplay = item.show_on_site === "yes";
        const isUrgent = item.priority === "urgent";

        // RESTORED EXPIRATION LOGIC
        const exp1 = item.expiration_site1;
        const expText1 = exp1 ? (exp1 < Date.now() ? `<span class="text-red-600 font-bold">Expired</span>` : new Date(exp1).toLocaleString()) : 'Never Set';
        const exp2 = item.expiration_site2;
        const expText2 = exp2 ? (exp2 < Date.now() ? `<span class="text-red-600 font-bold">Expired</span>` : new Date(exp2).toLocaleString()) : 'Never Set';

        // AUTO-EXPIRE TASK
        if (granted1 && exp1 && exp1 < Date.now()) {
            update(ref(db, DB_PATH + "/" + item.key), { granted_site1: "no", expiration_site1: null });
        }
        if (granted2 && exp2 && exp2 < Date.now()) {
            update(ref(db, DB_PATH + "/" + item.key), { granted_site2: "no", expiration_site2: null });
        }

        const card = document.createElement("div");
        card.className = `bg-white p-4 md:p-6 rounded-lg shadow border-l-4 ${userAllowsReportDisplay ? 'border-blue-600' : 'border-red-600'}`;

        card.innerHTML = `
          <div class="flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                   <span class="bg-blue-800 text-white text-xs font-bold px-2 py-1 rounded">#${hId}</span>
                   <h3 class="text-lg font-semibold text-red-700">${escape(item.report_type)} Report</h3>
                </div>
                ${isUrgent ? '<span class="text-xs bg-red-600 text-white px-2 py-1 rounded font-bold animate-pulse">‚ö† URGENT</span>' : ''}
            </div>
            <span class="text-xs text-slate-500">Submitted: ${d} | Event Time: <input class="input-edit" value="${escape(item.time)}" id="time-${item.key}"></span>
            <p class="text-xs text-blue-800 font-bold">Email ID: <span class="font-normal text-slate-600">${escape(item.email || 'N/A')}</span></p>

            <p class="text-sm text-slate-600 mt-2"><strong>Location:</strong> ${escape(item.location)}</p>
            <p class="text-sm text-slate-600"><strong>Reporter:</strong> <input class="input-edit" value="${escape(item.name)}" id="name-${item.key}"></p>
            <p class="mt-3 text-slate-800 whitespace-pre-wrap font-medium">
                <textarea class="input-edit" id="obs-${item.key}" rows="3">${escape(item.observation)}</textarea>
            </p>

            <div class="text-sm mt-3 p-3 bg-slate-50 rounded border border-slate-200">
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1 border-r border-slate-200 pr-2">
                        <span class="font-bold text-blue-800 text-xs">Site 1 Settings</span>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Duration (Hrs)</label>
                        <input type="number" min="1" value="24" class="input-edit !mt-0 w-full" id="dur1-${item.key}">
                        <p class="text-[9px] mt-1 text-slate-500 leading-tight">Live until: <br>${expText1}</p>
                    </div>
                    <div class="flex flex-col gap-1 pl-2">
                        <span class="font-bold text-indigo-800 text-xs">Site 2 Settings</span>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Duration (Hrs)</label>
                        <input type="number" min="1" value="24" class="input-edit !mt-0 w-full" id="dur2-${item.key}">
                        <p class="text-[9px] mt-1 text-slate-500 leading-tight">Live until: <br>${expText2}</p>
                    </div>
                </div>
            </div>

            <div class="text-sm mt-2 flex gap-4">
                <span class="font-semibold ${userAllowsReportDisplay ? 'text-green-600' : 'text-red-600'}">Show on Site: ${userAllowsReportDisplay ? '‚úÖ' : '‚ùå'}</span>
                <span class="font-semibold ${item.show_name === 'yes' ? 'text-green-600' : 'text-red-600'}">Show Name: ${item.show_name === 'yes' ? '‚úÖ' : '‚ùå'}</span>
            </div>

            ${item.photo_url && item.photo_url!=="N/A" ? `<a href="${escape(item.photo_url)}" target="_blank"><img src="${escape(item.photo_url)}" class="report-photo-thumb"></a>` : ''}

            <div class="flex flex-wrap gap-3 mt-2 items-center">
                <span class="text-xs font-semibold p-1 rounded ${granted1 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">Site 1: ${granted1 ? '‚úÖ Granted' : '‚ùå Not Granted'}</span>
                <span class="text-xs font-semibold p-1 rounded ${granted2 ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500'}">Site 2: ${granted2 ? '‚úÖ Granted' : '‚ùå No Granted'}</span>
            </div>

            <div id="btn-container-${item.key}" class="flex gap-2 mt-3 flex-wrap"></div>
          </div>
        `;
        messagesList.appendChild(card);
        const btnContainer = document.getElementById(`btn-container-${item.key}`);

        if (!userAllowsReportDisplay) {
            btnContainer.innerHTML = `<div class="p-3 bg-red-50 text-red-700 rounded-md font-medium text-sm w-full">‚ùå User denied permission.</div>`;
            btnContainer.appendChild(createDeleteButton(item.key, hId));
        } else {
            btnContainer.appendChild(createGrantRevokeButton(1, granted1, item.key, '', hId));
            btnContainer.appendChild(createGrantRevokeButton(2, granted2, item.key, '!bg-indigo-600', hId));
            btnContainer.appendChild(createDeleteButton(item.key, hId));
        }
    });
}

const createGrantRevokeButton = (siteNum, isGranted, key, color, hId) => {
    const btn = document.createElement('button');
    const grantField = `granted_site${siteNum}`;
    const expField = `expiration_site${siteNum}`;
    const durInputId = `dur${siteNum}-${key}`;

    // Find the specific item in our local data
    const item = allReports.find(r => r.key === key);

    if (isGranted) {
        btn.textContent = `Revoke Site ${siteNum}`;
        btn.className = 'revoke-btn'; 
        btn.onclick = async () => {
            await update(ref(bridgeDB, DB_PATH + "/" + key), { 
                [grantField]: "no",
                [expField]: null 
            });
            setStatus(`Report ${hId} revoked from Site ${siteNum} ‚ùå`, "info");
        };
    } else {
        btn.textContent = `Grant Site ${siteNum}`;
        btn.className = `grant-btn ${color}`; 
        btn.onclick = async () => {
            const duration = document.getElementById(durInputId).value;
            const durationMs = parseInt(duration) * 3600000;
            
            // Privacy Logic: If user said 'no' to name, we send 'Anonymous'
            const adminNameInput = document.getElementById(`name-${key}`).value.trim();
            const finalDisplayName = (item.show_name === 'yes') ? adminNameInput : "Anonymous";

            // The exact package you requested for the bridge
            const bridgeData = {
                report_type: item.report_type || "General", // Added Report Type
                display_name: finalDisplayName,             
                location: item.location,                    
                submitted_at: item.timestamp,               
                event_time: document.getElementById(`time-${key}`).value.trim(), 
                report_content: document.getElementById(`obs-${key}`).value.trim(), 
                [grantField]: "yes",                        
                [expField]: Date.now() + durationMs         
            };

            await update(ref(bridgeDB, DB_PATH + "/" + key), bridgeData);
            setStatus(`Report ${hId} live on Site ${siteNum} for ${duration}h ‚úî`, "success");
        };
    }
    return btn;
};

const createDeleteButton = (key, hId) => {
    const btn = document.createElement('button');
    btn.className = "revoke-btn px-3 py-2 !bg-red-600 text-white rounded text-sm hover:!bg-red-700";
    btn.textContent = "Delete";
    btn.onclick = async () => {
        if (confirm(`Permanently delete report ${hId}?`)) {
            await remove(ref(db, DB_PATH + "/" + key));
            setStatus(`Report ${hId} deleted üóë`, "error");
        }
    };
    return btn;
};
// Logout Event Listener
logoutBtn.addEventListener("click", () => {
  if (confirm("Are you sure you want to logout?")) {
    signOut(auth)
      .then(() => {
        setStatus("Logged out successfully.", "info");
      })
      .catch((error) => {
        setStatus("Error logging out: " + error.message, "error");
      });
  }
});
function escape(s) {
  if (!s) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
</script>
</body>
</html>
