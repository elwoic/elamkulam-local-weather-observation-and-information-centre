<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elamkulam Weather Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --secondary: #f59e0b; --bg: #f8fafc; }
        body { 
    background: transparent;   /* remove grey */
    font-family: 'Poppins', sans-serif; 
    margin: 0; 
    padding: 10px; 
}

        
        .weather-mini-dashboard { 
            max-width: 550px; margin: 5px auto; padding: 15px; 
            background: #fff; border-radius: 14px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
        }
        
        .weather-mini-dashboard h2 { text-align: center; color: #004080; font-size: 1.1em; margin-bottom: 15px; }

        /* Forced 4-column layout for all devices */
        .info-boxes { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
        }
        
        .info-box { 
            background: var(--bg); border-radius: 8px; border: 1px solid #f1f5f9; 
            text-align: center; padding: 8px 4px; position: relative;
            min-height: 65px; display: flex; flex-direction: column; justify-content: center;
        }
        .info-box.primary { border-top: 3px solid var(--primary); }
        .info-box.secondary { border-top: 3px solid var(--secondary); }
        
        .info-title { font-size: 0.5rem; color: #64748b; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .info-value { font-size: 0.9rem; font-weight: 700; color: #1e293b; line-height: 1.1; }
        .info-unit { font-size: 0.55rem; color: #94a3b8; }

        .pressure-sub { font-size: 0.45rem; color: #64748b; margin-top: 2px; font-weight: 500; }

        .update-tag { font-size:0.55rem; color:#64748b; text-align:center; margin-top:10px; }

        /* Single Row Push Action Area */
        .push-section { 
            margin-top: 12px; padding-top: 10px; border-top: 1px solid #e2e8f0; 
            display: flex; align-items: center; justify-content: space-between; gap: 5px;
        }
        
        #log-btn { 
            background: var(--primary); color: white; border: none; 
            padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.6rem; 
            cursor: pointer; transition: 0.3s; white-space: nowrap;
        }
        #log-btn:disabled { background: #cbd5e1; cursor: not-allowed; }

        .timer-display { font-size: 0.6rem; color: #64748b; text-align: right; }
        #cooldown-timer { font-weight: 700; color: #ef4444; }

        .about-link { text-align: center; margin-top: 5px; }
        .about-link a { font-size: 0.55rem; color: var(--primary); text-decoration: none; font-weight: 600; }

        #log-status { font-size: 0.6rem; text-align: center; color: #059669; font-weight: 600; margin-top: 4px; }
        
        .footer-legal { 
            margin-top: 12px; padding-top: 8px; border-top: 1px solid #f1f5f9;
            font-size: 0.5rem; color: #94a3b8; line-height: 1.3; text-align: justify;
        }
        .footer-legal a { color: var(--primary); text-decoration: underline; }
    </style>
</head>
<body>

<section class="weather-mini-dashboard">
    <h2>üå¶ ‡¥è‡¥≤‡¥Ç‡¥ï‡µÅ‡¥≥‡¥Ç ‡¥ï‡¥æ‡¥≤‡¥æ‡¥µ‡¥∏‡µç‡¥• - ‡¥∏‡µç‡¥Æ‡¥æ‡µº‡¥ü‡µç‡¥ü‡µç ‡¥µ‡µç‡¥Ø‡µÇ</h2>

    <div class="info-boxes">
        <div class="info-box primary">
            <span class="info-title">‡¥§‡¥æ‡¥™‡¥®‡¥ø‡¥≤</span>
            <div class="info-value"><span id="temp">--</span><span class="info-unit">¬∞C</span></div>
        </div>
        <div class="info-box primary">
            <span class="info-title">‡¥Ü‡µº‡¥¶‡µç‡¥∞‡¥§</span>
            <div class="info-value"><span id="humidity">--</span><span class="info-unit">%</span></div>
        </div>
        <div class="info-box">
            <span class="info-title">FEELS LIKE</span>
            <div class="info-value"><span id="feels">--</span><span class="info-unit">¬∞C</span></div>
        </div>
        <div class="info-box">
            <span class="info-title">‡¥¶‡µÉ‡¥∂‡µç‡¥Ø‡¥™‡¥∞‡¥ø‡¥ß‡¥ø</span>
            <div class="info-value"><span id="visibility">--</span><span class="info-unit">km</span></div>
        </div>
        
        <div class="info-box">
            <span class="info-title">‡¥ï‡¥æ‡¥±‡µç‡¥±‡µç (Avg)</span>
            <div class="info-value"><span id="wind">--</span><span class="info-unit">km/h</span></div>
        </div>
        <div class="info-box secondary">
            <span class="info-title">Consensus T</span>
            <div class="info-value"><span id="om-temp">--</span><span class="info-unit">¬∞C</span></div>
        </div>
        <div class="info-box secondary">
            <span class="info-title">Consensus H</span>
            <div class="info-value"><span id="om-humidity">--</span><span class="info-unit">%</span></div>
            <div class="pressure-sub">P: <span id="pressure">--</span></div>
        </div>
        <div class="info-box" style="background: #f0fdf4; border-top: 3px solid #10b981;">
            <span class="info-title">‡¥Ö‡¥µ‡¥∏‡µç‡¥•</span>
            <div class="info-value" id="condition" style="font-size: 0.6rem; color: #065f46;">Loading...</div>
        </div>
    </div>

    <p class="update-tag">Last Updated: <span id="last-updated">--</span></p>

    <div class="push-section">
        <button id="log-btn" disabled>Syncing...</button>
        <div class="timer-display">Next: <span id="cooldown-timer">--:--</span></div>
         
    <div class="about-link">
        <a href="about-weather-push.html">What is "Push Data"?</a>
    </div>
    </div>
   
    
    <p id="log-status"></p>

    <div class="footer-legal">
        Data from an <b>AirGradient</b> monitor (CC BY-SA 4.0). 
        <a href="#" onclick="toggleLegal(); return false;">Read legal notice</a>
       
        <div id="legal-more" style="display:none; margin-top:5px;">
            Air quality, Temperature and Humidity data is sourced via the AirGradient Cloud API and is available under the 
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a> license. 
            ELWOIC independently processes and presents this data.
            <br><br>
            <b>Disclaimer:</b> Data is provided "as-is" without warranty. 
            Do not rely on it for medical, regulatory, or emergency decisions.
        </div>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDo3Rm9PBZ8GZqOucYh1VyCCc3hBPLbTn4",
        authDomain: "report-20d26.firebaseapp.com",
        databaseURL: "https://report-20d26-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "report-20d26"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const API_URL = "https://curly-sound-5bea.elwoicelamkulam.workers.dev/api";
    const OW_KEY = "ca13a2cbdc07e7613b6af82cff262295";
    const LAT = 10.9081; const LON = 76.2296;
    
    let currentLogData = {}; 
    let lastPushTimeUTC = null;
    let timer = null;

    function getAQIStatus(aqi) {
        if (aqi <= 50) return "Excellent";
        if (aqi <= 100) return "Good";
        if (aqi <= 150) return "Moderate";
        if (aqi <= 200) return "Unhealthy";
        if (aqi <= 300) return "Very Unhealthy";
        return "Hazardous";
    }

    function pm25ToAQI(pm) {
        const bp = [{cL:0,cH:12,aL:0,aH:50},{cL:12.1,cH:35.4,aL:51,aH:100},{cL:35.5,cH:55.4,aL:101,aH:150},{cL:55.5,cH:150.4,aL:151,aH:200},{cL:150.5,cH:250.4,aL:201,aH:300},{cL:250.5,cH:500,aL:301,aH:500}];
        const r = bp.find(range => pm >= range.cL && pm <= range.cH) || bp[0];
        return Math.round(((r.aH-r.aL)/(r.cH-r.cL))*(pm-r.cL)+r.aL);
    }

    function getRealisticFeelsLike(t, rh, apiFeels) {
        if (t < 26) return t.toFixed(1);
        const T = (t * 9/5) + 32;
        let hi = -42.379 + 2.04901523*T + 10.14333127*rh - 0.22475541*T*rh - 0.00683783*T*T - 0.05481717*rh*rh + 0.00122874*T*T*rh + 0.00085282*T*rh*rh - 0.00000199*T*T*rh*rh;
        return (((hi-32)*5/9) * 0.3 + apiFeels * 0.7).toFixed(1);
    }

    async function loadWeatherSnapshot() {
        try {
            const [workerRes, owRes, omRes] = await Promise.all([
                fetch(API_URL).then(r => r.json()),
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&appid=${OW_KEY}&units=metric`).then(r => r.json()),
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current_weather=true&hourly=relativehumidity_2m&timezone=Asia/Kolkata`).then(r => r.json())
            ]);

            const localT = workerRes.atmp_corrected;
            const localH = workerRes.rhum_corrected;
            const pm25Val = workerRes.pm02_corrected;
            const aqiVal = pm25ToAQI(pm25Val);
            const aqiStat = getAQIStatus(aqiVal);
            const visibilityKm = parseFloat((owRes.visibility / 1000).toFixed(1));
            
            const realFeels = getRealisticFeelsLike(localT, localH, owRes.main.feels_like);
            const avgWind = ((owRes.wind.speed * 3.6 + omRes.current_weather.windspeed) / 2).toFixed(1);
            const omH = omRes.hourly.relativehumidity_2m[new Date().getHours()];

            const skyMap = {"Clear":"‡¥§‡µÜ‡¥≥‡¥ø‡¥û‡µç‡¥û ‡¥Ü‡¥ï‡¥æ‡¥∂‡¥Ç","Clouds":"‡¥Æ‡µá‡¥ò‡¥æ‡¥µ‡µÉ‡¥§‡¥Ç","Rain":"‡¥Æ‡¥¥","Drizzle":"‡¥ö‡¥æ‡¥±‡µç‡¥±‡µΩ ‡¥Æ‡¥¥","Mist":"‡¥Æ‡¥û‡µç‡¥û‡µç","Haze":"‡¥Æ‡¥û‡µç‡¥û‡µç"};
            const sky = skyMap[owRes.weather[0].main] || owRes.weather[0].main;
            const comfort = localH > 80 ? " (Humid)" : (localT > 32 ? " (Hot)" : " (Pleasant)");
            
            document.getElementById("temp").textContent = localT.toFixed(1);
            document.getElementById("humidity").textContent = localH;
            document.getElementById("feels").textContent = realFeels;
            document.getElementById("visibility").textContent = visibilityKm;
            document.getElementById("om-temp").textContent = ((owRes.main.temp + omRes.current_weather.temperature)/2).toFixed(1);
            document.getElementById("om-humidity").textContent = Math.round((owRes.main.humidity + omH)/2);
            document.getElementById("pressure").textContent = owRes.main.pressure;
            document.getElementById("condition").textContent = sky + comfort;
            document.getElementById("wind").textContent = avgWind;

            document.getElementById("last-updated").textContent = new Date().toLocaleTimeString("en-IN", {timeZone: "Asia/Kolkata", hour:"2-digit", minute:"2-digit"});

            currentLogData = {
                temp_c: localT,
                humidity: localH,
                feels_like_c: parseFloat(realFeels),
                aqi: aqiVal,
                aqi_status: aqiStat,
                pressure_hpa: owRes.main.pressure,
                wind_kmh: parseFloat(avgWind),
                visibility_km: visibilityKm, // Added visibility to push
                condition: sky + comfort,
                timestamp_utc: new Date().toISOString(),
                timestamp_ist: new Date().toLocaleString("en-IN", {timeZone: "Asia/Kolkata"})
            };

        } catch (err) { console.error("Update Error", err); }
    }

    onValue(query(ref(db, "weather_logs"), limitToLast(1)), (snapshot) => {
        if (!snapshot.exists()) { enableBtn(); return; }
        lastPushTimeUTC = new Date(Object.values(snapshot.val())[0].timestamp_utc).getTime();
        startTimer();
    });

    function startTimer() {
        if (timer) clearInterval(timer);
        timer = setInterval(() => {
            const remain = (30 * 60) - Math.floor((Date.now() - lastPushTimeUTC) / 1000);
            if (remain <= 0) { enableBtn(); clearInterval(timer); } 
            else {
                document.getElementById("log-btn").disabled = true;
                document.getElementById("log-btn").textContent = "Wait";
                document.getElementById("cooldown-timer").textContent = Math.floor(remain/60).toString().padStart(2,'0') + ":" + (remain%60).toString().padStart(2,'0');
            }
        }, 1000);
    }

    function enableBtn() {
        document.getElementById("log-btn").disabled = false;
        document.getElementById("log-btn").textContent = "üì§ Push Data";
        document.getElementById("cooldown-timer").textContent = "Ready";
    }

    document.getElementById("log-btn").onclick = async () => {
        try {
            await push(ref(db, "weather_logs"), currentLogData);
            document.getElementById("log-status").textContent = "‚úÖ Success!";
            setTimeout(() => { document.getElementById("log-status").textContent = ""; }, 3000);
        } catch (err) { document.getElementById("log-status").textContent = "‚ùå Failed"; }
    };

    loadWeatherSnapshot();
    setInterval(loadWeatherSnapshot, 10 * 60 * 1000);
</script>
<script>
function toggleLegal() {
    const el = document.getElementById("legal-more");
    el.style.display = el.style.display === "none" ? "block" : "none";
}
</script>

</body>
</html>
