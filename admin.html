<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ELWOIC — Admin Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
  <header class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-10">
    <div class="container mx-auto flex items-center justify-between">
      <div>
        <h1 class="text-lg md:text-2xl font-bold">ELWOIC Admin: Messages</h1>
        <p class="text-xs opacity-80">Realtime message viewer</p>
      </div>
      <div class="space-x-2">
        <button id="exportBtn" class="px-3 py-2 bg-white text-blue-900 rounded shadow-sm hidden">Export CSV</button>
        <span id="countBadge" class="inline-block bg-white text-blue-900 px-3 py-1 rounded hidden"></span>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div id="status" class="mb-4 p-3 rounded text-sm bg-blue-100 text-blue-800">Initializing...</div>

    <div id="controls" class="mb-4 hidden">
      <input id="filterInput" placeholder="Filter by name/email/subject..." class="p-2 border rounded w-full md:w-1/2" />
    </div>

    <div id="messagesList" class="space-y-4">
      <!-- messages show here -->
    </div>

    <div id="empty" class="hidden text-center p-8 bg-white rounded shadow border-dashed border-2 border-gray-300">
      <p class="text-gray-600">No messages yet.</p>
    </div>
  </main>

  <footer class="text-center text-sm text-gray-500 py-6">
    Admin panel — protect this page. For stronger security use Firebase Auth or server-side protection.
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, remove
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // --------------------- CONFIG ---------------------
    const firebaseConfig = {
      apiKey: "AIzaSyC_Ckz9wFQxXgWivmvIt5ISp7bT9tWbxCY",
      authDomain: "elwoic.firebaseapp.com",
      databaseURL: "https://elwoic-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "elwoic",
      storageBucket: "elwoic.firebasestorage.app",
      messagingSenderId: "597873791800",
      appId: "1:597873791800:web:d78dd1d5c3005b2ec8e7cd",
      measurementId: "G-0KZS7RPGKK"
    };
    // ----------------- ADMIN PASS (client-side) -----------------
    // Change this to your own passphrase. Note: client-side passphrase is not secure.
    const ADMIN_PASSPHRASE = "elwoic-admin";

    // initialize
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // elements
    const statusEl = document.getElementById('status');
    const messagesList = document.getElementById('messagesList');
    const emptyEl = document.getElementById('empty');
    const exportBtn = document.getElementById('exportBtn');
    const countBadge = document.getElementById('countBadge');
    const controls = document.getElementById('controls');
    const filterInput = document.getElementById('filterInput');

    // ask for passphrase
    let allowed = false;
    try {
      const entered = prompt("Enter admin passphrase:");
      if (entered && entered === ADMIN_PASSPHRASE) {
        allowed = true;
        controls.classList.remove('hidden');
      }
    } catch (e) {}

    if (!allowed) {
      statusEl.textContent = "Access denied — wrong passphrase. Refresh to try again.";
      statusEl.className = "mb-4 p-3 rounded text-sm bg-red-100 text-red-800";
      // hide body content
      messagesList.style.display = 'none';
    } else {
      startListening();
    }

    // helper: set status
    function setStatus(text, kind = 'info') {
      statusEl.textContent = text;
      statusEl.className = "mb-4 p-3 rounded text-sm";
      if (kind === 'info') statusEl.classList.add('bg-blue-100', 'text-blue-800');
      if (kind === 'success') statusEl.classList.add('bg-green-100', 'text-green-800');
      if (kind === 'error') statusEl.classList.add('bg-red-100', 'text-red-800');
    }

    // store data snapshot for filtering/export
    let currentData = [];

    // start realtime listener
    function startListening() {
      setStatus('Connecting to Firebase...');

      const msgsRef = ref(db, 'messages');
      onValue(msgsRef, (snap) => {
        const val = snap.val();
        if (!val) {
          currentData = [];
          messagesList.innerHTML = '';
          emptyEl.classList.remove('hidden');
          exportBtn.classList.add('hidden');
          countBadge.classList.add('hidden');
          setStatus('No messages found.', 'info');
          return;
        }

        // convert to array of { key, ...data }
        currentData = Object.entries(val).map(([key, data]) => ({ key, ...data }));
        // sort newest first by timestamp
        currentData.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

        render(currentData);
        setStatus(`Loaded ${currentData.length} message(s).`, 'success');
        exportBtn.classList.remove('hidden');
        countBadge.classList.remove('hidden');
        countBadge.textContent = `${currentData.length} messages`;
      }, (err) => {
        console.error(err);
        setStatus('Failed to load messages: ' + (err.message || err), 'error');
      });

      // filter input
      filterInput.addEventListener('input', () => {
        const q = (filterInput.value || '').trim().toLowerCase();
        if (!q) return render(currentData);
        const filtered = currentData.filter(item =>
          (item.name||'').toLowerCase().includes(q) ||
          (item.email||'').toLowerCase().includes(q) ||
          (item.subject||'').toLowerCase().includes(q) ||
          (item.message||'').toLowerCase().includes(q)
        );
        render(filtered);
      });

      // export
      exportBtn.addEventListener('click', () => {
        exportCSV(currentData);
      });
    }

    // render message cards
    function render(list) {
      messagesList.innerHTML = '';
      if (!list || list.length === 0) {
        emptyEl.classList.remove('hidden');
        return;
      }
      emptyEl.classList.add('hidden');

      list.forEach(item => {
        const card = document.createElement('div');
        card.className = 'bg-white p-4 md:p-6 rounded-lg shadow border-l-4 border-blue-600';

        const date = item.timestamp ? new Date(item.timestamp).toLocaleString() : '';

        card.innerHTML = `
          <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h3 class="text-lg font-semibold text-slate-800">${escapeHtml(item.subject || 'No subject')}</h3>
                <span class="text-xs text-slate-500 ml-2">${date}</span>
              </div>
              <p class="text-sm text-slate-600 mt-1"><strong>${escapeHtml(item.name || '')}</strong> — <a href="mailto:${escapeHtml(item.email || '')}" class="text-blue-700">${escapeHtml(item.email || '')}</a></p>
              <p class="mt-3 text-slate-800 whitespace-pre-wrap">${escapeHtml(item.message || '')}</p>
            </div>

            <div class="flex flex-col items-end gap-2">
              <button class="deleteBtn px-3 py-2 bg-red-600 text-white rounded text-sm">Delete</button>
            </div>
          </div>
        `;

        // attach delete handler
        const deleteBtn = card.querySelector('.deleteBtn');
        deleteBtn.addEventListener('click', async () => {
          const ok = confirm('Delete this message? This cannot be undone.');
          if (!ok) return;
          try {
            await remove(ref(db, `messages/${item.key}`));
            setStatus('Message deleted.', 'success');
          } catch (err) {
            console.error(err);
            setStatus('Failed to delete message.', 'error');
          }
        });

        messagesList.appendChild(card);
      });
    }

    // export CSV helper
    function exportCSV(arr) {
      if (!arr || arr.length === 0) {
        alert('No messages to export.');
        return;
      }

      const header = ['key','timestamp','name','email','subject','message'];
      const rows = arr.map(it => [
        `"${it.key}"`,
        `"${it.timestamp || ''}"`,
        `"${(it.name||'').replace(/"/g,'""')}"`,
        `"${(it.email||'').replace(/"/g,'""')}"`,
        `"${(it.subject||'').replace(/"/g,'""')}"`,
        `"${(it.message||'').replace(/"/g,'""')}"`
      ].join(','));

      const csv = [header.join(','), ...rows].join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      a.download = `elwoic-messages-${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // small utility to escape HTML (avoid simple injection in admin view)
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'", '&#039;');
    }
  </script>
</body>
</html>
