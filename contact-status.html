<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Site Status Control</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --gray-100: #f3f4f6;
            --gray-300: #d1d5db;
            --text: #1f2937;
            --temp-bg: #eff6ff;
        }

        body { font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; color: var(--text); padding: 40px 20px; margin: 0; }
        .admin-panel { max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 30px; border: 1px solid var(--gray-300); }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gray-100); padding-bottom: 20px; margin-bottom: 30px; }
        .live-preview { padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 14px; border: 1px solid var(--gray-300); }
        .preview-on { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .preview-off { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

        .section { margin-bottom: 20px; border: 1px solid var(--gray-100); border-radius: 8px; overflow: hidden; }
        .section-header { background: #fff; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray-100); }
        .section-content { padding: 20px; display: none; }
        .section.active .section-content { display: block; }
        
        h3 { font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin: 0; }
        
        .btn-sm { padding: 6px 12px; font-size: 13px; border-radius: 4px; border: 1px solid var(--gray-300); cursor: pointer; background: white; transition: all 0.2s; color: var(--text); }
        .btn-sm:hover { border-color: var(--primary); }
        .btn-sm:disabled { cursor: not-allowed; opacity: 0.5; background: var(--gray-100); }
        
        .active-online { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .active-offline { background: var(--danger) !important; color: white !important; border-color: var(--danger) !important; }
        .active-auto { background: var(--primary) !important; color: white !important; border-color: var(--primary) !important; }
        .pending-offline-btn { border: 2px dashed var(--danger) !important; color: var(--danger) !important; font-weight: bold; }
        .btn-blue { background: var(--primary); color: white; border-color: var(--primary); }

        .status-pill { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; align-items: center; }
        
        .temp-session-box { background: var(--temp-bg); border: 1px solid #bfdbfe; padding: 15px; border-radius: 8px; display: flex; gap: 15px; align-items: center; font-size: 13px; }

        .schedule-grid { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .schedule-grid td { padding: 12px 8px; border-bottom: 1px solid var(--gray-100); font-size: 14px; }
        .day-label { font-weight: 600; width: 140px; }
        
        input[type="time"], input[type="text"], input[type="date"] { border: 1px solid var(--gray-300); padding: 6px; border-radius: 4px; font-size: 13px; }
        
        .update-box { background: var(--gray-100); padding: 15px; border-radius: 8px; text-align: right; margin-top: 10px; }
        .info-note { font-size: 12px; color: #64748b; margin-bottom: 10px; padding: 10px; background: #fef9c3; border-radius: 6px; border: 1px solid #fde047; }
    </style>
</head>
<body>

<div class="admin-panel">
    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 22px;">Site Management</h1>
            <p style="color: #64748b; margin: 5px 0 0 0;">Control your contact availability in real-time.</p>
        </div>
        <div id="status-display" class="live-preview">‚óè LOADING...</div>
    </div>

    <div style="margin-bottom: 35px;">
        <div class="flex-between" style="margin-bottom: 15px;">
            <h3>1. Manual Status & Temporary Session</h3>
            <button class="btn-sm" style="color: var(--danger);" onclick="resetAll()">Reset to Default Schedule</button>
        </div>
        
        <div class="status-pill">
            <button id="btn-force-online" class="btn-sm" onclick="setManual('available')">Force Online</button>
            <button id="btn-force-offline" class="btn-sm" onclick="setManual('away')">Force Offline</button>
            <button id="btn-auto-schedule" class="btn-sm" onclick="setManual('auto')">Switch to Auto-Schedule</button>

            <div class="temp-session-box">
                <strong>Temp Online:</strong>
                <input type="time" id="temp-start">
                <span>to</span>
                <input type="time" id="temp-end">
                <div style="font-size:11px; display:flex; flex-direction:column; gap:2px;">
                    <label><input type="radio" name="temp-after" value="auto" checked> Then Auto</label>
                    <label><input type="radio" name="temp-after" value="away"> Then Offline</label>
                </div>
                <button class="btn-sm btn-blue" onclick="setTempSession()">Set Session</button>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <label id="note-label" style="font-size: 13px; display: block; margin-bottom: 5px;">Reason for being away (Force Offline mode):</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="away-note" placeholder="Write reason..." style="width:100%" disabled>
                <button id="btn-update-note" class="btn-sm" onclick="updateNoteAndOffline()" disabled>Update Note</button>
            </div>
            <p id="pending-msg" style="font-size: 11px; color: var(--danger); margin-top: 5px; display: none;">* Click "Update Note" to apply the Offline status to the site.</p>
        </div>
    </div>

    <div class="section" id="sec-weekly">
        <div class="section-header" onclick="toggleSection('sec-weekly')">
            <h3>2. Weekly Schedule Settings</h3>
            <span id="weekly-arrow">‚ñº</span>
        </div>
        <div class="section-content">
            <div class="info-note">
                <strong>üí° Tip:</strong> For overnight (e.g., 18:00 to 08:00), just enter the times normally. For 24h (Sat/Sun), use 00:00 to 23:59.
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size: 14px;"><input type="checkbox" id="master-switch"> Master: Follow Schedules</label>
            </div>
            <div style="margin-top: 20px;">
    <label style="font-size: 13px; display: block; margin-bottom: 5px;">
        Reason for Auto-Schedule being offline:
    </label>
    <div style="display: flex; gap: 10px;">
        <input type="text" id="auto-note" placeholder="Write reason for auto offline..." style="width:100%">
        <button id="btn-update-auto-note" class="btn-sm btn-blue" onclick="updateAutoNote()">Update Note</button>
    </div>
</div>

            <table class="schedule-grid" id="days-table"></table>
            <div class="update-box">
                <button class="btn-sm btn-blue" onclick="saveWeeklySchedule()">Update Weekly Hours</button>
            </div>
        </div>
    </div>

    <div class="section" id="sec-dated">
        <div class="section-header" onclick="toggleSection('sec-dated')">
            <h3>3. Dated Overrides (Next 7 Days)</h3>
            <span id="dated-arrow">‚ñº</span>
        </div>
        <div class="section-content">
            <p style="font-size:12px; color:#64748b; margin-top:0;">Overrides Auto-Schedule for specific dates.</p>
            <table class="schedule-grid" id="dated-table"></table>
            <div class="update-box">
                <button class="btn-sm btn-blue" onclick="saveDatedSchedule()">Update Dated Overrides</button>
            </div>
        </div>
    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyCTdb7oM8hayioOOkyNycm10Pnb8sAOVm4",
    authDomain: "contact-controll.firebaseapp.com",
    databaseURL: "https://contact-controll-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "contact-controll",
    storageBucket: "contact-controll.firebasestorage.app",
    messagingSenderId: "357811399820",
    appId: "1:357811399820:web:6674904d6e18e68d7cdfa9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, "site_config");

const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let latestData = null;

// Initialize Tables UI once
const wTable = document.getElementById('days-table');
days.forEach(day => {
    wTable.innerHTML += `<tr><td class="day-label">${day}</td><td><input type="checkbox" id="check-${day}"> Active</td><td><input type="time" id="start-${day}"></td><td>to</td><td><input type="time" id="end-${day}"></td></tr>`;
});

const dTable = document.getElementById('dated-table');
for (let i = 0; i < 7; i++) {
    let date = new Date();
    date.setDate(date.getDate() + i);
    let dateStr = date.toISOString().split('T')[0];
    let displayStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    dTable.innerHTML += `<tr data-date="${dateStr}"><td class="day-label">${displayStr}</td><td><input type="checkbox" id="date-active-${dateStr}"> Override</td><td><input type="checkbox" id="date-24h-${dateStr}"> 24h</td><td><input type="time" id="date-start-${dateStr}"> to <input type="time" id="date-end-${dateStr}"></td></tr>`;
}

// Logic Utils
function timeToNumber(t){ return t ? parseInt(t.replace(":","")) : 0; }
function isInsideRange(start,end,current){
    return (start <= end) ? (current >= start && current <= end) : (current >= start || current <= end);
}

function computeLiveStatus(data){
    const now = new Date();
    const todayStr = now.toISOString().split("T")[0];
    const currentTime = now.getHours()*100 + now.getMinutes();
    const currentDay = days[(now.getDay()+6)%7];

    if(data.tempSession){
        const start = timeToNumber(data.tempSession.start);
        const end = timeToNumber(data.tempSession.end);
        if(isInsideRange(start,end,currentTime)) return "available";
        
        const revTo = data.tempSession.revertTo;
        update(dbRef, { tempSession: null, useSchedule: (revTo === 'auto'), currentStatus: (revTo === 'away' ? 'away' : 'scheduled') });
    }

    if(!data.useSchedule) return data.currentStatus === "available" ? "available" : "away";

    if(data.datedOverrides && data.datedOverrides[todayStr]?.active){
        const o = data.datedOverrides[todayStr];
        if(o.is24h) return "available";
        return isInsideRange(timeToNumber(o.start), timeToNumber(o.end), currentTime) ? "available" : "away";
    }

    if(data.schedule && data.schedule[currentDay]?.active){
        const s = data.schedule[currentDay];
        return isInsideRange(timeToNumber(s.start), timeToNumber(s.end), currentTime) ? "available" : "away";
    }
    return "away";
}

function renderUI(data){
    const liveStatus = computeLiveStatus(data);
    if(data.liveStatus !== liveStatus) update(dbRef, { liveStatus });

    const display = document.getElementById("status-display");
    display.innerText = "‚óè LIVE: " + liveStatus.toUpperCase();
    display.className = "live-preview " + (liveStatus === "available" ? "preview-on" : "preview-off");

    const mode = data.useSchedule ? "auto" : (data.currentStatus === "available" ? "available" : "away");
    
    // Status Buttons
    document.getElementById('btn-force-online').className = "btn-sm " + (mode === "available" ? "active-online" : "");
    document.getElementById('btn-force-offline').className = "btn-sm " + (mode === "away" ? "active-offline" : "");
    document.getElementById('btn-auto-schedule').className = "btn-sm " + (mode === "auto" ? "active-auto" : "");

    // Note Section Logic
    const noteInput = document.getElementById("away-note");
    const noteBtn = document.getElementById("btn-update-note");
    const pendingMsg = document.getElementById("pending-msg");

    // Only enable the note fields if we are in 'away' mode OR if the offline button was clicked
    if (mode === 'away' || document.getElementById('btn-force-offline').classList.contains('pending-offline-btn')) {
        noteInput.disabled = false;
        noteBtn.disabled = false;
        noteBtn.classList.add('btn-blue');
    } else {
        noteInput.disabled = true;
        noteBtn.disabled = true;
        noteBtn.classList.remove('btn-blue');
        pendingMsg.style.display = 'none';
    }

    document.getElementById("master-switch").checked = data.useSchedule || false;
    document.getElementById("away-note").value = data.awayNote || "";

    // Sync Weekly inputs
    if(data.schedule) days.forEach(d => {
        if(data.schedule[d]) {
            document.getElementById(`check-${d}`).checked = data.schedule[d].active;
            document.getElementById(`start-${d}`).value = data.schedule[d].start || "";
            document.getElementById(`end-${d}`).value = data.schedule[d].end || "";
        }
    });

    // Sync Dated inputs
    if(data.datedOverrides) Object.keys(data.datedOverrides).forEach(date => {
        const el = document.getElementById(`date-active-${date}`);
        if(el) {
            el.checked = data.datedOverrides[date].active;
            document.getElementById(`date-24h-${date}`).checked = data.datedOverrides[date].is24h;
            document.getElementById(`date-start-${date}`).value = data.datedOverrides[date].start || "";
            document.getElementById(`date-end-${date}`).value = data.datedOverrides[date].end || "";
        }
    });
}

onValue(dbRef, (snap) => { latestData = snap.val() || {}; renderUI(latestData); });
setInterval(() => { if(latestData) renderUI(latestData); }, 30000);

// Actions
window.setManual = (m) => {
    if (m === 'away') {
        // Unlock UI first so user can type the reason
        document.getElementById('btn-force-offline').classList.add('pending-offline-btn');
        document.getElementById('away-note').disabled = false;
        document.getElementById('btn-update-note').disabled = false;
        document.getElementById('btn-update-note').classList.add('btn-blue');
        document.getElementById('pending-msg').style.display = 'block';
        document.getElementById('away-note').focus();
    } else {
        document.getElementById('btn-force-offline').classList.remove('pending-offline-btn');
        update(dbRef, { 
            useSchedule: (m==='auto'), 
            currentStatus: (m==='auto'?'scheduled':m), 
            tempSession: null, 
            awayNote: "" 
        });
    }
};

window.updateNoteAndOffline = () => {
    const note = document.getElementById("away-note").value;
    update(dbRef, { 
        currentStatus: "away", 
        useSchedule: false, 
        tempSession: null,
        awayNote: note 
    }).then(() => {
        document.getElementById('btn-force-offline').classList.remove('pending-offline-btn');
        document.getElementById('pending-msg').style.display = 'none';
        alert("Status Updated to Offline with Note.");
    });
};

window.resetAll = () => { if(confirm("Reset?")) window.setManual('auto'); };

window.setTempSession = () => {
    const s = document.getElementById("temp-start").value, e = document.getElementById("temp-end").value;
    const r = document.querySelector('input[name="temp-after"]:checked').value;
    if(!s || !e) return alert("Select times.");
    update(dbRef, { useSchedule: false, currentStatus: "available", tempSession: {start:s, end:e, revertTo:r}, awayNote: "" });
};

window.saveWeeklySchedule = () => {
    const schedule = {};
    days.forEach(d => { schedule[d] = { active: document.getElementById(`check-${d}`).checked, start: document.getElementById(`start-${d}`).value, end: document.getElementById(`end-${d}`).value }; });
    update(dbRef, { schedule, useSchedule: document.getElementById('master-switch').checked });
    alert("Saved.");
};

window.updateAutoNote = () => {
    const note = document.getElementById("auto-note").value;
    update(dbRef, { autoOfflineNote: note }).then(() => {
        alert("Auto-Schedule offline reason updated.");
    });
};

window.saveDatedSchedule = () => {
    const dated = {};
    document.querySelectorAll('#dated-table tr').forEach(row => {
        const d = row.getAttribute('data-date');
        dated[d] = { active: document.getElementById(`date-active-${d}`).checked, is24h: document.getElementById(`date-24h-${d}`).checked, start: document.getElementById(`date-start-${d}`).value, end: document.getElementById(`date-end-${d}`).value };
    });
    update(dbRef, { datedOverrides: dated });
    alert("Saved.");
};
</script>

<script>
function toggleSection(id) {
    const sec = document.getElementById(id);
    sec.classList.toggle("active");
    sec.querySelector("span").textContent = sec.classList.contains("active") ? "‚ñ≤" : "‚ñº";
}
</script>
</body>
</html>
